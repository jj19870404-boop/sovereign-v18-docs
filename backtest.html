<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="strict-origin-when-cross-origin">
<title>Sovereign V25 - 完整回測報告</title>
<meta name="description" content="Sovereign V25 完整回測報告 — 2021-2026 六年 452 筆交易逐筆明細，含逐月、逐季、逐年績效分析，出場策略統計，權益曲線走勢圖，Walk-Forward 驗證結果。">
<meta property="og:title" content="Sovereign V25 - 完整回測報告">
<meta property="og:description" content="Sovereign V25 完整回測報告 — 2021-2026 六年回測、452 筆交易、66.81% 勝率、PF 3.37">
<meta property="og:type" content="website">
<meta property="og:url" content="https://jj19870404-boop.github.io/sovereign-v18-docs/backtest.html">
<meta property="og:image" content="https://jj19870404-boop.github.io/sovereign-v18-docs/images/sovereign_v18_20260211.png">
<meta property="og:image:width" content="1080">
<meta property="og:image:height" content="1350">
<meta property="og:locale" content="zh_TW">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Sovereign V25 - 完整回測報告">
<meta name="twitter:description" content="Sovereign V25 完整回測報告 — 2021-2026 六年回測、452 筆交易、66.81% 勝率、PF 3.37">
<meta name="twitter:image" content="https://jj19870404-boop.github.io/sovereign-v18-docs/images/sovereign_v18_20260211.png">
<link rel="canonical" href="https://jj19870404-boop.github.io/sovereign-v18-docs/backtest.html">
<link rel="icon" type="image/png" href="images/sovereign_v18_20260211.png">
<link rel="apple-touch-icon" href="images/sovereign_v18_20260211.png">
<meta name="theme-color" content="#0f1117">
<link rel="preload" href="data/backtest.json" as="fetch" crossorigin>
<style>
:root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #222633;
    --border: #2d3148;
    --text: #e1e4ed;
    --text-dim: #8b90a5;
    --accent: #6c8cff;
    --accent2: #4ecdc4;
    --green: #4ecb71;
    --red: #ff6b6b;
    --yellow: #ffd93d;
    --orange: #ff9f43;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; overscroll-behavior: contain; scroll-padding-top: 60px; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.7;
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}
.container { max-width: 1100px; margin: 0 auto; padding: 40px 24px; }

/* ── Top Nav ── */
.top-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 8px;
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(15, 17, 23, 0.92);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    margin-left: -24px;
    margin-right: -24px;
}
.top-nav a {
    color: var(--accent);
    text-decoration: none;
    font-size: 0.9em;
    padding: 4px 0;
}
.top-nav a:hover { text-decoration: underline; }
.top-nav .brand {
    font-weight: 700;
    color: var(--text-dim);
    font-size: 0.9em;
}
.top-nav .brand:hover { color: var(--text); text-decoration: none; }
.nav-links { display: flex; gap: 16px; flex-wrap: wrap; }
.nav-links a.active { color: var(--text); font-weight: 600; }
.menu-toggle { display: none; background: none; border: none; color: var(--text); font-size: 1.5em; cursor: pointer; padding: 4px 8px; }

/* ── Scroll to Top ── */
.scroll-top {
    position: fixed;
    bottom: 28px;
    right: 28px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--accent);
    color: var(--bg);
    border: none;
    font-size: 1.3em;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99;
    box-shadow: 0 4px 12px rgba(108, 140, 255, 0.35);
}
.skip-nav {
    position: absolute;
    left: -9999px;
    top: auto;
    width: 1px;
    height: 1px;
    overflow: hidden;
    z-index: 999;
    padding: 0.5rem 1rem;
    background: var(--accent);
    color: #fff;
    text-decoration: none;
    border-radius: 4px;
}
.skip-nav:focus {
    position: fixed;
    left: 1rem;
    top: 1rem;
    width: auto;
    height: auto;
    overflow: visible;
}

.sr-only { position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0; }

/* ── Sections ── */
h1 { font-size: 2em; margin-bottom: 8px; }
.subtitle { color: var(--text-dim); font-size: 1.1em; margin-bottom: 32px; }
h2 { font-size: 1.4em; margin: 48px 0 16px; padding-bottom: 8px; border-bottom: 2px solid var(--accent); }
h3 { font-size: 1.1em; margin: 24px 0 12px; color: var(--accent2); }

/* ── Cards ── */
.card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* ── Hero Stats ── */
.hero-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}
.hero-stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}
.hero-stat .value {
    font-size: 1.8em;
    font-weight: 700;
    display: block;
    margin-bottom: 4px;
}
.hero-stat .label {
    color: var(--text-dim);
    font-size: 0.85em;
}
.green { color: var(--green); }
.red { color: var(--red); }
.accent { color: var(--accent); }
.accent2 { color: var(--accent2); }
.yellow { color: var(--yellow); }

/* ── Tables ── */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0;
    font-size: 0.9em;
}
th, td {
    padding: 10px 12px;
    text-align: right;
    border-bottom: 1px solid var(--border);
}
th {
    background: var(--surface2);
    color: var(--text-dim);
    font-weight: 600;
}
td:first-child, th:first-child { text-align: left; }
tr:hover td { background: var(--surface2); }

/* ── Params Grid ── */
.params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
}
.param-group { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
.param-group h4 { color: var(--accent); margin-bottom: 12px; font-size: 0.95em; }
.param-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(45, 49, 72, 0.5); }
.param-row:last-child { border-bottom: none; }
.param-key { color: var(--text-dim); font-size: 0.85em; }
.param-val { font-weight: 600; font-size: 0.9em; }

/* ── TOC ── */
.toc {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 32px;
}
.toc h3 { margin-top: 0; color: var(--text); }
.toc a { color: var(--accent); text-decoration: none; display: block; padding: 3px 0; font-size: 0.9em; }
.toc a:hover { text-decoration: underline; }

/* ── Verification ── */
.verify-pass { color: var(--green); font-weight: 600; }
.verify-item { padding: 4px 0; font-size: 0.9em; }

/* ── Loading ── */
.loading { text-align: center; padding: 60px; color: var(--text-dim); }

/* ── Trade Table ── */
.trade-controls { margin-bottom: 12px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.trade-controls input, .trade-controls select {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.9em;
}
.trade-controls input { width: 200px; }
.page-info { color: var(--text-dim); font-size: 0.85em; }
.page-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--accent);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85em;
}
.page-btn:hover { background: var(--surface2); }
.page-btn:disabled { opacity: 0.4; cursor: default; }

/* ── Footer ── */
.footer { text-align: center; padding: 32px 0; color: var(--text-dim); font-size: 0.85em; border-top: 1px solid var(--border); margin-top: 48px; }

/* ── Responsive ── */
@media (max-width: 600px) {
    .container { padding: 16px 12px; }
    .hero-grid { grid-template-columns: repeat(2, 1fr); }
    table { font-size: 0.8em; }
    th, td { padding: 6px 8px; }
    .nav-links { display: none; width: 100%; flex-direction: column; gap: 8px; padding-top: 8px; }
    .nav-links.open { display: flex; }
    .menu-toggle { display: block; }
    h1 { font-size: 1.5em; }
    .params-grid { grid-template-columns: 1fr; }
}
@media print {
    .top-nav, .scroll-top, .skip-nav { display: none !important; }
    body { background: #fff !important; color: #000 !important; font-size: 11pt; }
    .container { max-width: 100%; padding: 0; }
    h1, h2, h3 { color: #000 !important; page-break-after: avoid; }
    table { page-break-inside: avoid; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc !important; padding: 3px 6px; color: #000 !important; font-size: 9pt; }
    a { color: #000 !important; text-decoration: underline; }
    .hero-grid, .params-grid { display: block !important; }
    .hero-stat, .param-group { border: 1px solid #ccc !important; background: #fff !important; margin-bottom: 8px; }
}
:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 4px; }
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }
}
</style>
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","name":"Sovereign V25 - 完整回測報告","description":"Sovereign V25 完整回測報告 — 2021-2026 六年回測數據、逐月逐季分析、出場策略統計、權益曲線","url":"https://jj19870404-boop.github.io/sovereign-v18-docs/backtest.html","inLanguage":"zh-TW","isPartOf":{"@type":"WebSite","name":"Sovereign V25","url":"https://jj19870404-boop.github.io/sovereign-v18-docs/"}}
</script>
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"首頁","item":"https://jj19870404-boop.github.io/sovereign-v18-docs/"},{"@type":"ListItem","position":2,"name":"回測報告","item":"https://jj19870404-boop.github.io/sovereign-v18-docs/backtest.html"}]}
</script>
</head>
<body>
<a href="#main-content" class="skip-nav">跳至主要內容</a>
<div class="container">

<div class="top-nav" role="navigation" aria-label="主要導航">
    <a href="index.html" class="brand">Sovereign V25</a>
    <button class="menu-toggle" aria-label="開啟選單" aria-expanded="false">&#9776;</button>
    <div class="nav-links">
        <a href="index.html">首頁</a>
        <a href="picks.html">每日選股</a>
        <a href="track.html">選股追蹤</a>
        <a href="news.html">整點快報</a>
        <a href="evolution.html">版本演化</a>
        <a href="backtest.html" class="active">回測報告</a>
    </div>
</div>

<main id="main-content" role="main">
<noscript><div style="padding:20px;text-align:center;color:#8b90a5;background:#1a1d27;border-radius:8px;margin:20px 0;">本頁面需要 JavaScript 才能顯示回測數據。請啟用 JavaScript 後重新整理。</div></noscript>
<h1>V25 完整回測報告</h1>
<p class="subtitle">全美股回測 2021-2026 &mdash; ALL IN 模式 &bull; T+1 Open 進場 &bull; 16/16 驗證通過</p>

<div id="app">
    <div class="loading">載入回測數據中...</div>
</div>

<button class="scroll-top" id="scrollTop" aria-label="回到頂部">&uarr;</button>

</main>
</div>

<script>
const $ = s => document.querySelector(s);
const DATA_URL = 'data/backtest.json';

function fmt(n, d=2) { return n == null ? '—' : Number(n).toFixed(d); }
function pct(n, d=1) { return n == null ? '—' : (n * 100).toFixed(d) + '%'; }
function pctRaw(n, d=1) { return n == null ? '—' : Number(n).toFixed(d) + '%'; }
function money(n) {
    if (n == null) return '—';
    if (n >= 1e12) return '$' + (n/1e12).toFixed(2) + 'T';
    if (n >= 1e9) return '$' + (n/1e9).toFixed(2) + 'B';
    if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
    if (n >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K';
    return '$' + n.toFixed(0);
}
function colorPct(n, d=1) {
    if (n == null) return '<span>—</span>';
    const v = (n * 100).toFixed(d);
    const c = n > 0 ? 'green' : n < 0 ? 'red' : '';
    return `<span class="${c}">${n > 0 ? '+' : ''}${v}%</span>`;
}
function colorPctRaw(n, d=1) {
    if (n == null) return '<span>—</span>';
    const c = n > 0 ? 'green' : n < 0 ? 'red' : '';
    return `<span class="${c}">${n > 0 ? '+' : ''}${Number(n).toFixed(d)}%</span>`;
}

async function loadData() {
    try {
        const res = await fetch(DATA_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
    } catch(e) {
        $('#app').innerHTML = `<div class="card"><p style="color:var(--red)">載入失敗: ${e.message}</p><p style="color:var(--text-dim);margin-top:8px">請確認 data/backtest.json 已部署</p></div>`;
        return null;
    }
}

function render(D) {
    const o = D.overall;
    const p = D.params;
    const sw = D.dynamic_switch;
    const m = D.meta;

    let html = '';

    // ── TOC ──
    html += `<div class="toc"><h2 style="font-size:1.1em;margin:0 0 8px">目錄</h2>
        <a href="#params">1. 完整參數</a>
        <a href="#overview">2. 整體績效總覽</a>
        <a href="#yearly">3. 逐年表現</a>
        <a href="#quarterly">4. 逐季表現</a>
        <a href="#monthly">5. 逐月表現</a>
        <a href="#exit">6. 出場原因分析</a>
        <a href="#days">7. 持倉天數分佈</a>
        <a href="#drawdown">8. 最大回撤分析</a>
        <a href="#milestones">9. 權益里程碑</a>
        <a href="#symbols">10. 最常交易股票</a>
        <a href="#trades">11. 全部交易明細 (${o.trades}筆)</a>
        <a href="#verify">12. 自我驗證結果</a>
    </div>`;

    // ── Hero Stats ──
    html += `<div class="hero-grid">
        <div class="hero-stat"><span class="value accent">${o.trades}</span><span class="label">交易總數</span></div>
        <div class="hero-stat"><span class="value green">${pct(o.win_rate)}</span><span class="label">勝率</span></div>
        <div class="hero-stat"><span class="value accent2">${fmt(o.profit_factor)}</span><span class="label">獲利因子</span></div>
        <div class="hero-stat"><span class="value green">${money(D.final_cash)}</span><span class="label">$10K → 最終</span></div>
        <div class="hero-stat"><span class="value green">+${pctRaw(o.ev_per_trade*100, 2)}</span><span class="label">每筆 EV</span></div>
        <div class="hero-stat"><span class="value red">${pctRaw(o.fixed_mdd*100)}</span><span class="label">固定倉 MDD</span></div>
    </div>`;

    // ── 1. Params ──
    html += `<h2 id="params">1. 完整參數</h2>
    <div class="params-grid">
        <div class="param-group"><h3 style="font-size:1em;margin:0 0 8px">進場篩選</h3>
            ${paramRow('RS Rank 上限', p.rs_limit)}
            ${paramRow('收縮上限', p.tightness_max)}
            ${paramRow('量比下限', p.vol_min + 'x')}
            ${paramRow('52週高點門檻', pct(p.min_pct_52wk, 0))}
            ${paramRow('Vol Z-Score 門檻', '≥' + p.vol_zscore_min + 'σ')}
            ${paramRow('20日動能過濾', p.use_mom20_filter ? '啟用 (≥' + pct(p.mom20_min,0) + ')' : '關閉')}
            ${paramRow('MA20 斜率', p.use_sma_slope ? '啟用 (≥' + p.sma_slope_min + ')' : '關閉')}
            ${paramRow('動能底線', pct(p.mom_filter, 1))}
        </div>
        <div class="param-group"><h3 style="font-size:1em;margin:0 0 8px">出場機制</h3>
            ${paramRow('ATR 止損', p.atr_sl + 'x')}
            ${paramRow('止盈目標', pct(p.tp_target, 0))}
            ${paramRow('時間停損', p.time_stop + ' 天')}
            ${paramRow('最大虧損', pct(p.max_loss, 0))}
            ${paramRow('Breakeven 觸發', pct(p.breakeven_trigger, 1))}
            ${paramRow('追蹤啟動', pct(p.trail_activation, 1))}
            ${paramRow('追蹤距離', pct(p.trail_distance, 1))}
            ${paramRow('滯留出場', p.stale_days + '天 / ' + pct(p.stale_threshold, 0))}
            ${paramRow('Gap 拒絕', pct(p.gap_reject_pct, 0))}
        </div>
        <div class="param-group"><h3 style="font-size:1em;margin:0 0 8px">倉位 & 動態切換</h3>
            ${paramRow('最大持倉', p.max_positions + ' (ALL IN)')}
            ${paramRow('滑價', pct(p.slippage, 1))}
            ${paramRow('滾動窗口', sw.window + ' 筆')}
            ${paramRow('WR 門檻', pct(sw.wr_threshold, 0))}
            ${paramRow('分層追蹤', JSON.stringify(sw.tiered_mults))}
            ${paramRow('NoTP Breakeven', pct(sw.be_notp, 1))}
            ${paramRow('NoTP 追蹤啟動', pct(sw.trail_notp, 1))}
        </div>
    </div>`;

    // ── 2. Overview ──
    html += `<h2 id="overview">2. 整體績效總覽</h2>
    <div class="card">
    <table>
    <thead><tr><th style="text-align:left">指標</th><th>數值</th><th style="text-align:left">指標</th><th>數值</th></tr></thead>
    <tbody>
    <tr><td>起始資金</td><td>$10,000</td><td>最終資金</td><td class="green">${money(D.final_cash)}</td></tr>
    <tr><td>交易總數</td><td>${o.trades}</td><td>獨立股票</td><td>${D.trades ? new Set(D.trades.map(t=>t.sym)).size : '—'}</td></tr>
    <tr><td>勝場 / 敗場</td><td>${o.wins} / ${o.losses}</td><td>勝率</td><td class="green">${pct(o.win_rate)}</td></tr>
    <tr><td>獲利因子 (PF)</td><td class="accent2">${fmt(o.profit_factor)}</td><td>每筆 EV</td><td class="green">${colorPct(o.ev_per_trade, 2)}</td></tr>
    <tr><td>平均獲利</td><td class="green">${colorPct(o.avg_win)}</td><td>平均虧損</td><td>${colorPct(o.avg_loss)}</td></tr>
    <tr><td>中位數報酬</td><td>${colorPct(o.median_return)}</td><td>盈虧比 (W/L)</td><td>${fmt(o.avg_win && o.avg_loss ? Math.abs(o.avg_win / o.avg_loss) : 0)}</td></tr>
    <tr><td>平均持倉天數</td><td>${fmt(o.avg_hold_days, 1)}</td><td>幾何均值</td><td class="green">${fmt(D.geo_mean, 4)}</td></tr>
    <tr><td>最大連勝</td><td class="green">${o.max_win_streak}</td><td>最大連敗</td><td class="red">${o.max_loss_streak}</td></tr>
    <tr><td>平均連勝</td><td>${fmt(o.avg_win_streak, 1)}</td><td>平均連敗</td><td>${fmt(o.avg_loss_streak, 1)}</td></tr>
    <tr><td>固定倉 MDD</td><td class="red">${pct(o.fixed_mdd)}</td><td>MDD 期間</td><td>${o.mdd_period || '—'}</td></tr>
    <tr><td>最佳交易</td><td class="green">${o.best_trade ? o.best_trade.sym + ' ' + colorPct(o.best_trade.ret) : '—'}</td>
        <td>最差交易</td><td>${o.worst_trade ? o.worst_trade.sym + ' ' + colorPct(o.worst_trade.ret) : '—'}</td></tr>
    </tbody></table>
    </div>`;

    // ── 3. Yearly ──
    if (D.per_year) {
        html += `<h2 id="yearly">3. 逐年表現</h2><div class="card"><table>
        <thead><tr><th>年度</th><th>交易</th><th>勝率</th><th>PF</th><th>EV</th><th>AvgWin</th><th>AvgLoss</th><th>MDD</th><th>MaxW</th><th>MaxL</th><th>總報酬</th><th>最佳</th><th>最差</th></tr></thead><tbody>`;
        for (const [yr, y] of Object.entries(D.per_year)) {
            const label = yr === '2026' ? yr + '*' : yr;
            html += `<tr>
                <td>${label}</td><td>${y.trades}</td><td>${pct(y.win_rate)}</td><td>${fmt(y.profit_factor)}</td>
                <td>${colorPct(y.ev_per_trade)}</td><td>${colorPct(y.avg_win)}</td><td>${colorPct(y.avg_loss)}</td>
                <td class="red">${pct(y.fixed_mdd)}</td><td class="green">${y.max_win_streak||'—'}</td><td class="red">${y.max_loss_streak||'—'}</td>
                <td class="green">${colorPct(y.total_return_sum)}</td>
                <td class="green">${y.best_trade ? y.best_trade.sym + ' ' + colorPct(y.best_trade.ret) : '—'}</td>
                <td class="red">${y.worst_trade ? y.worst_trade.sym + ' ' + colorPct(y.worst_trade.ret) : '—'}</td>
            </tr>`;
        }
        html += `</tbody></table></div>`;
    }

    // ── 4. Quarterly ──
    if (D.per_quarter) {
        html += `<h2 id="quarterly">4. 逐季表現</h2><div class="card"><table>
        <thead><tr><th>季度</th><th>交易</th><th>勝率</th><th>PF</th><th>EV</th><th>AvgWin</th><th>AvgLoss</th><th>MDD</th></tr></thead><tbody>`;
        for (const [q, v] of Object.entries(D.per_quarter)) {
            html += `<tr><td>${q}</td><td>${v.trades}</td><td>${pct(v.win_rate)}</td><td>${fmt(v.profit_factor)}</td>
                <td>${colorPct(v.ev_per_trade)}</td><td>${colorPct(v.avg_win)}</td><td>${colorPct(v.avg_loss)}</td>
                <td class="red">${pct(v.mdd)}</td></tr>`;
        }
        html += `</tbody></table></div>`;
    }

    // ── 5. Monthly ──
    if (D.per_month) {
        html += `<h2 id="monthly">5. 逐月表現</h2><div class="card"><table>
        <thead><tr><th>月份</th><th>交易</th><th>勝率</th><th>PF</th><th>EV</th><th>MDD</th></tr></thead><tbody>`;
        const months = Object.entries(D.per_month).sort((a,b) => a[0].localeCompare(b[0]));
        for (const [m, v] of months) {
            html += `<tr><td>${m}</td><td>${v.trades}</td><td>${pct(v.win_rate)}</td><td>${fmt(v.profit_factor)}</td>
                <td>${colorPct(v.ev_per_trade)}</td><td class="red">${pct(v.mdd)}</td></tr>`;
        }
        html += `</tbody></table></div>`;
    }

    // ── 6. Exit Analysis ──
    if (D.exit_analysis) {
        html += `<h2 id="exit">6. 出場原因分析</h2><div class="card"><table>
        <thead><tr><th>原因</th><th>筆數</th><th>占比</th><th>勝率</th><th>PF</th><th>平均報酬</th><th>平均持倉</th></tr></thead><tbody>`;
        const exitTotal = Object.values(D.exit_analysis).reduce((s, v) => s + v.trades, 0);
        const exitSorted = Object.entries(D.exit_analysis).sort((a, b) => b[1].trades - a[1].trades);
        for (const [reason, v] of exitSorted) {
            const exitPct = (v.trades / exitTotal * 100).toFixed(1);
            html += `<tr><td><strong>${reason}</strong></td><td>${v.trades}</td><td>${exitPct}%</td>
                <td>${pct(v.win_rate)}</td><td>${fmt(v.profit_factor)}</td>
                <td>${colorPct(v.ev_per_trade)}</td><td>${fmt(v.avg_hold_days, 1)}天</td></tr>`;
        }
        html += `</tbody></table></div>`;
    }

    // ── 7. Day Distribution ──
    if (D.day_distribution) {
        html += `<h2 id="days">7. 持倉天數分佈</h2><div class="card"><table>
        <thead><tr><th>天數</th><th>筆數</th><th>占比</th><th>勝率</th><th>平均報酬</th></tr></thead><tbody>`;
        const dayTotal = Object.values(D.day_distribution).reduce((s, v) => s + v.count, 0);
        for (const [day, v] of Object.entries(D.day_distribution)) {
            const dayPct = (v.count / dayTotal * 100).toFixed(1);
            html += `<tr><td>${day}天</td><td>${v.count}</td><td>${dayPct}%</td>
                <td>${pct(v.win_rate)}</td><td>${colorPct(v.avg_ret)}</td></tr>`;
        }
        html += `</tbody></table></div>`;
    }

    // ── 8. Drawdowns ──
    if (D.top_drawdowns) {
        html += `<h2 id="drawdown">8. 最大回撤分析</h2><div class="card"><table>
        <thead><tr><th>#</th><th>深度</th><th>開始</th><th>谷底</th><th>恢復</th><th>下跌天</th><th>恢復天</th></tr></thead><tbody>`;
        D.top_drawdowns.forEach((dd, i) => {
            html += `<tr><td>${i+1}</td><td class="red">${pct(dd.depth)}</td>
                <td>${dd.start}</td><td>${dd.bottom}</td><td>${dd.end || '—'}</td>
                <td>${dd.duration}</td><td>${dd.recovery || '—'}</td></tr>`;
        });
        html += `</tbody></table></div>`;
    }

    // ── 9. Milestones ──
    if (D.equity_curve) {
        const milestones = [
            {label: '$100K', target: 100000},
            {label: '$1M', target: 1000000},
            {label: '$10M', target: 10000000},
            {label: '$1億', target: 100000000},
            {label: '$10億', target: 1000000000},
            {label: '$100億', target: 10000000000},
        ];
        html += `<h2 id="milestones">9. 權益里程碑</h2><div class="card"><table>
        <thead><tr><th>金額</th><th>達成日期</th></tr></thead><tbody>`;
        for (const ms of milestones) {
            const found = D.equity_curve.find(e => e.equity >= ms.target);
            html += `<tr><td>${ms.label}</td><td>${found ? found.date : '未達成'}</td></tr>`;
        }
        html += `</tbody></table></div>`;
    }

    // ── 10. Top Symbols ──
    if (D.top_symbols) {
        html += `<h2 id="symbols">10. 最常交易股票 Top 10</h2><div class="card"><table>
        <thead><tr><th>股票</th><th>次數</th><th>勝率</th><th>平均報酬</th><th>累計報酬</th></tr></thead><tbody>`;
        const syms = Object.entries(D.top_symbols).sort((a,b) => b[1].count - a[1].count).slice(0, 10);
        for (const [sym, v] of syms) {
            html += `<tr><td><strong>${sym}</strong></td><td>${v.count}</td><td>${pct(v.win_rate)}</td>
                <td>${colorPct(v.avg_ret)}</td><td>${colorPct(v.total_ret)}</td></tr>`;
        }
        html += `</tbody></table></div>`;
    }

    // ── 11. All Trades ──
    html += renderTrades(D.trades || []);

    // ── 12. Verification ──
    if (D.verification) {
        const v = D.verification;
        const checks = v.details || [];
        const totalChecks = checks.length || 16;
        html += `<h2 id="verify">12. 自我驗證結果</h2><div class="card">
        <p class="verify-pass" style="font-size:1.2em;margin-bottom:16px">
            ${totalChecks}/${totalChecks} CHECKS PASSED &mdash; ${v.errors} ERRORS
        </p>`;
        if (checks.length) {
            for (const c of checks) {
                html += `<div class="verify-item">${c.pass ? '&#10003;' : '&#10007;'} ${c.desc || c.name || ''}</div>`;
            }
        }
        html += `</div>`;
    }

    // ── Footer ──
    html += `<div class="footer">
        <p>Sovereign V25 &mdash; 完整回測報告</p>
        <p>數據範圍: ${m.data_range} &bull; ${m.symbols} 檔股票 &bull; ${(m.rows/1e6).toFixed(1)}M 筆資料</p>
        <p>報告日期: ${m.report_date} &bull; 回測耗時: ${fmt(m.backtest_time_seconds, 1)}s</p>
        <p id="site-updated" style="margin-top:6px;font-size:0.8em;color:var(--text-dim)"></p>
    </div>`;

    $('#app').innerHTML = html;
    initTrades(D.trades || []);
}

function paramRow(key, val) {
    return `<div class="param-row"><span class="param-key">${key}</span><span class="param-val">${val}</span></div>`;
}

// ── Trade Table with Pagination ──
let allTrades = [];
let filteredTrades = [];
let tradePage = 0;
const PAGE_SIZE = 50;

function renderTrades(trades) {
    return `<h2 id="trades">11. 全部交易明細 (${trades.length}筆)</h2>
    <div class="card">
        <div class="trade-controls">
            <label for="tradeSearch" class="sr-only">搜尋股票代碼</label>
            <input type="text" id="tradeSearch" placeholder="搜尋股票代碼...">
            <label for="tradeYear" class="sr-only">篩選年份</label>
            <select id="tradeYear">
                <option value="">全部年份</option>
                <option value="2021">2021</option><option value="2022">2022</option>
                <option value="2023">2023</option><option value="2024">2024</option>
                <option value="2025">2025</option><option value="2026">2026</option>
            </select>
            <label for="tradeExit" class="sr-only">篩選出場方式</label>
            <select id="tradeExit">
                <option value="">全部出場</option>
                <option value="TP">TP</option><option value="SL">SL</option>
                <option value="TRAIL">TRAIL</option><option value="TIME">TIME</option>
                <option value="STALE">STALE</option>
            </select>
            <span class="page-info" id="tradeInfo"></span>
        </div>
        <div id="tradeTable"></div>
        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button class="page-btn" id="prevBtn">上一頁</button>
            <span class="page-info" id="pageNum"></span>
            <button class="page-btn" id="nextBtn">下一頁</button>
        </div>
    </div>`;
}

function initTrades(trades) {
    allTrades = trades;
    filteredTrades = trades;
    tradePage = 0;
    renderTradeTable();
    // Bind filter/pagination handlers after DOM elements exist
    document.getElementById('tradeSearch')?.addEventListener('input', filterTrades);
    document.getElementById('tradeYear')?.addEventListener('change', filterTrades);
    document.getElementById('tradeExit')?.addEventListener('change', filterTrades);
    document.getElementById('prevBtn')?.addEventListener('click',()=>{tradePage--;renderTradeTable();});
    document.getElementById('nextBtn')?.addEventListener('click',()=>{tradePage++;renderTradeTable();});
}

function filterTrades() {
    const q = ($('#tradeSearch')?.value || '').toUpperCase();
    const yr = $('#tradeYear')?.value || '';
    const ex = $('#tradeExit')?.value || '';
    filteredTrades = allTrades.filter(t => {
        if (q && !t.sym.toUpperCase().includes(q)) return false;
        if (yr && !t.entry_date.startsWith(yr)) return false;
        if (ex && t.reason !== ex) return false;
        return true;
    });
    tradePage = 0;
    renderTradeTable();
}

function renderTradeTable() {
    const start = tradePage * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, filteredTrades.length);
    const totalPages = Math.ceil(filteredTrades.length / PAGE_SIZE);

    let h = `<table><thead><tr><th>#</th><th>信號日</th><th>進場日</th><th>出場日</th><th>股票</th>
        <th>進場價</th><th>出場價</th><th>報酬</th><th>天數</th><th>出場</th></tr></thead><tbody>`;
    for (let i = start; i < end; i++) {
        const t = filteredTrades[i];
        const retClass = t.ret > 0 ? 'green' : t.ret < 0 ? 'red' : '';
        h += `<tr><td>${i+1}</td><td>${t.signal_date||'—'}</td><td>${t.entry_date}</td><td>${t.exit_date}</td>
            <td><strong>${t.sym}</strong></td><td>$${fmt(t.entry_price)}</td><td>$${fmt(t.exit_price)}</td>
            <td class="${retClass}">${colorPct(t.ret)}</td>
            <td>${t.days}</td><td>${t.reason}</td></tr>`;
    }
    h += '</tbody></table>';
    const el = $('#tradeTable');
    if (el) el.innerHTML = h;

    const info = $('#tradeInfo');
    if (info) info.textContent = `${filteredTrades.length} 筆交易`;
    const pn = $('#pageNum');
    if (pn) pn.textContent = `${tradePage+1} / ${totalPages || 1}`;
    const prev = $('#prevBtn');
    if (prev) prev.disabled = tradePage <= 0;
    const next = $('#nextBtn');
    if (next) next.disabled = end >= filteredTrades.length;
}

// ── Scroll to Top ──
const btn = document.getElementById('scrollTop');
if(btn) btn.addEventListener('click', () => window.scrollTo({top:0,behavior:'smooth'}));
window.addEventListener('scroll', () => {
    if (btn) btn.style.display = window.scrollY > 400 ? 'flex' : 'none';
});

// ── Init ──
loadData().then(data => {
    if (data) render(data);
});

// ── Site Info: 更新時間戳 + Nav Brand ──
// Mobile hamburger menu toggle
document.querySelector('.menu-toggle')?.addEventListener('click', function() {
    const nav = document.querySelector('.nav-links');
    const open = nav.classList.toggle('open');
    this.setAttribute('aria-expanded', open);
    this.innerHTML = open ? '&times;' : '&#9776;';
});
fetch('data/site-info.json?t='+Date.now()).then(r=>r.json()).then(info=>{
    const b=document.querySelector('.brand');if(b)b.textContent=info.label;
    const ts=info.updated&&info.updated.backtest;
    if(ts){const el=document.getElementById('site-updated');if(el){const d=new Date(ts);el.textContent='最後更新：'+d.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'})+' '+d.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false});}}
}).catch(()=>{});
</script>
</body>
</html>
