<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sovereign V20 - 每日選股報告</title>
<style>
:root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #222633;
    --border: #2d3148;
    --text: #e1e4ed;
    --text-dim: #8b90a5;
    --accent: #6c8cff;
    --accent2: #4ecdc4;
    --green: #4ecb71;
    --red: #ff6b6b;
    --yellow: #ffd93d;
    --orange: #ff9f43;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    font-size: 15px;
}
.container { max-width: 1080px; margin: 0 auto; padding: 24px; }

/* ── Top Nav ── */
.top-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
}
.top-nav a {
    color: var(--accent);
    text-decoration: none;
    font-size: 0.9em;
}
.top-nav a:hover { text-decoration: underline; }
.top-nav .brand {
    font-weight: 700;
    color: var(--text-dim);
    font-size: 0.9em;
}

/* ── Title ── */
h1 {
    font-size: 1.8em;
    text-align: center;
    margin-bottom: 24px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* ── Date Navigation ── */
.date-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-bottom: 28px;
}
.date-nav button {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--accent);
    width: 40px;
    height: 40px;
    border-radius: 8px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background 0.2s;
}
.date-nav button:hover:not(:disabled) { background: var(--surface2); }
.date-nav button:disabled { opacity: 0.3; cursor: default; }
.date-label {
    font-size: 1.3em;
    font-weight: 700;
    color: var(--text);
    min-width: 160px;
    text-align: center;
}

/* ── Dashboard ── */
.dashboard {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
}
.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
}
.stat-label {
    font-size: 0.8em;
    color: var(--text-dim);
    margin-bottom: 4px;
}
.stat-value {
    font-size: 1.35em;
    font-weight: 700;
}

/* ── Trade History ── */
.section-title {
    font-size: 0.85em;
    color: var(--text-dim);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}
.history {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 28px;
    padding: 12px 16px;
    background: var(--surface);
    border-radius: 8px;
    border: 1px solid var(--border);
    min-height: 36px;
    align-items: center;
}
.dot {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65em;
    font-weight: 700;
    color: var(--bg);
}
.dot-w { background: var(--green); }
.dot-l { background: var(--red); }

/* ── Section Headers ── */
h2 {
    font-size: 1.2em;
    color: var(--accent);
    margin: 28px 0 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}
h2 .dim { color: var(--text-dim); font-size: 0.85em; font-weight: 400; }

/* ── Open Trades Grid ── */
.trades-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
}
.trade-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
}
.trade-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.trade-symbol {
    font-size: 1.2em;
    font-weight: 700;
}
.trade-days {
    font-size: 0.85em;
    color: var(--text-dim);
}
.trade-mode {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.75em;
    font-weight: 600;
}
.mode-tp { background: rgba(78,203,113,0.2); color: var(--green); }
.mode-notp { background: rgba(255,159,67,0.2); color: var(--orange); }
.trade-prices {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    font-size: 0.9em;
    margin-top: 8px;
}
.trade-prices .lbl { color: var(--text-dim); }
.trade-prices .val { text-align: right; font-variant-numeric: tabular-nums; }
.trade-status {
    display: flex;
    gap: 10px;
    margin-top: 8px;
    font-size: 0.8em;
    color: var(--text-dim);
}
.trade-status .on { color: var(--green); }
.trade-status .off { color: var(--text-dim); }

/* ── Exit Cards ── */
.exit-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 8px;
}
.exit-symbol { font-weight: 700; font-size: 1.1em; min-width: 60px; }
.exit-reason {
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.8em;
    font-weight: 600;
}
.exit-return { font-weight: 700; font-variant-numeric: tabular-nums; }

/* ── Signal Card ── */
.signal-card {
    background: var(--surface);
    border: 2px solid var(--accent);
    border-radius: 14px;
    padding: 24px;
    position: relative;
    overflow: hidden;
}
.signal-card::before {
    content: '#1 SIGNAL';
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 0.7em;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 2px;
    opacity: 0.5;
}
.signal-top {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 6px;
}
.signal-symbol {
    font-size: 2em;
    font-weight: 800;
}
.signal-grade {
    padding: 4px 14px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.95em;
}
.signal-desc {
    font-size: 0.85em;
    color: var(--text-dim);
    margin-left: 4px;
}
.signal-sector {
    color: var(--text-dim);
    font-size: 0.9em;
    margin-bottom: 16px;
}
.signal-prices {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 14px;
}
.price-box {
    background: var(--surface2);
    border-radius: 8px;
    padding: 10px 12px;
    text-align: center;
}
.price-box .p-label {
    font-size: 0.75em;
    color: var(--text-dim);
    margin-bottom: 2px;
}
.price-box .p-value {
    font-size: 1.15em;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
}
.signal-risk {
    text-align: center;
    color: var(--text-dim);
    font-size: 0.9em;
    margin-bottom: 16px;
}
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}
.metric {
    background: var(--surface2);
    border-radius: 6px;
    padding: 8px;
    text-align: center;
}
.metric .m-label {
    font-size: 0.7em;
    color: var(--text-dim);
    margin-bottom: 2px;
}
.metric .m-value {
    font-size: 0.95em;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
}

/* ── Operation Plan ── */
.plan-section {
    margin-top: 20px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
}
.plan-title {
    font-size: 1em;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 12px;
}
.plan-steps {
    list-style: none;
    padding: 0;
}
.plan-steps li {
    padding: 6px 0;
    font-size: 0.9em;
    display: flex;
    gap: 8px;
}
.plan-steps .step-num {
    flex-shrink: 0;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--surface2);
    color: var(--accent);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75em;
    font-weight: 700;
}
.plan-steps .step-text {
    flex: 1;
}
.plan-warn {
    color: var(--red);
    font-size: 0.85em;
    padding-left: 30px;
    margin-top: -2px;
    margin-bottom: 4px;
}

/* ── Quality Analysis Table ── */
.qa-section {
    margin-top: 20px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
}
.qa-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
    margin-top: 8px;
}
.qa-table th {
    background: var(--surface2);
    color: var(--accent);
    padding: 8px 10px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border);
}
.qa-table td {
    padding: 7px 10px;
    border-bottom: 1px solid var(--border);
}
.qa-table .qa-score {
    font-weight: 700;
    text-align: center;
    font-variant-numeric: tabular-nums;
}
.qa-table .qa-reason {
    color: var(--text-dim);
    font-size: 0.92em;
}

/* ── Red Flags ── */
.red-flags {
    margin-top: 14px;
    padding: 12px 16px;
    background: rgba(255,107,107,0.08);
    border: 1px solid rgba(255,107,107,0.25);
    border-radius: 8px;
}
.red-flags-title {
    font-weight: 700;
    color: var(--red);
    font-size: 0.9em;
    margin-bottom: 6px;
}
.red-flags ul {
    list-style: none;
    padding: 0;
}
.red-flags li {
    font-size: 0.85em;
    color: var(--red);
    padding: 2px 0;
}
.red-flags li::before {
    content: '\27A4 ';
}
.no-flags {
    margin-top: 14px;
    padding: 10px 16px;
    background: rgba(78,203,113,0.08);
    border: 1px solid rgba(78,203,113,0.25);
    border-radius: 8px;
    font-size: 0.85em;
    color: var(--green);
}

/* ── Advanced Indicators ── */
.adv-section {
    margin-top: 20px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
}
.adv-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    font-size: 0.9em;
}
.adv-label {
    min-width: 90px;
    color: var(--text-dim);
    font-weight: 600;
}
.adv-value {
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    min-width: 60px;
}
.adv-note {
    color: var(--text-dim);
    font-size: 0.92em;
}

/* ── Quick Reference ── */
.quick-ref {
    margin-top: 28px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
}
.quick-ref-title {
    font-size: 1em;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 10px;
}
.quick-ref-row {
    display: flex;
    gap: 8px;
    font-size: 0.88em;
    padding: 4px 0;
    align-items: baseline;
}
.quick-ref-row .qr-label {
    font-weight: 700;
    min-width: 80px;
    flex-shrink: 0;
}
.quick-ref-row .qr-items {
    color: var(--text-dim);
}

/* ── Pick Detail Card (expandable) ── */
.pick-detail-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: border-color 0.2s;
}
.pick-detail-card:hover {
    border-color: var(--accent);
}
.pick-detail-header {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.pick-detail-rank {
    font-size: 0.8em;
    font-weight: 700;
    color: var(--accent);
    background: var(--surface2);
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.pick-detail-sym {
    font-size: 1.2em;
    font-weight: 800;
}
.pick-detail-prices {
    display: flex;
    gap: 16px;
    margin-left: auto;
    font-size: 0.88em;
    font-variant-numeric: tabular-nums;
}
.pick-detail-body {
    display: none;
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
}
.pick-detail-card.open .pick-detail-body {
    display: block;
}
.pick-detail-card.open {
    border-color: var(--accent);
}
.pick-detail-toggle {
    font-size: 0.8em;
    color: var(--text-dim);
    margin-left: 8px;
}
.detail-2col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    font-size: 0.88em;
    margin-bottom: 12px;
}
.detail-2col .d-lbl { color: var(--text-dim); }
.detail-2col .d-val { text-align: right; font-variant-numeric: tabular-nums; }

/* ── Picks Table ── */
.table-wrap {
    overflow-x: auto;
    border-radius: 10px;
    border: 1px solid var(--border);
}
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
    white-space: nowrap;
}
th {
    background: var(--surface2);
    color: var(--accent);
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border);
    position: sticky;
    top: 0;
}
td {
    padding: 9px 12px;
    border-bottom: 1px solid var(--border);
}
tr:hover td { background: rgba(108,140,255,0.05); }
.num { text-align: right; font-variant-numeric: tabular-nums; }
.grade-badge {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.85em;
}
tr:first-child td { background: rgba(108,140,255,0.08); }

/* ── Empty / Loading State ── */
.state-msg {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-dim);
}
.state-msg .icon { font-size: 2.5em; margin-bottom: 12px; }
.state-msg p { font-size: 1.05em; }

/* ── Footer ── */
.footer {
    margin-top: 48px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
    text-align: center;
    color: var(--text-dim);
    font-size: 0.85em;
}
.footer a {
    color: var(--accent);
    text-decoration: none;
}
.footer a:hover { text-decoration: underline; }

/* ── Responsive ── */
@media (max-width: 768px) {
    .dashboard { grid-template-columns: repeat(3, 1fr); }
    .signal-prices { grid-template-columns: repeat(2, 1fr); }
    .metrics-grid { grid-template-columns: repeat(3, 1fr); }
    .trades-grid { grid-template-columns: 1fr; }
    .pick-detail-prices { margin-left: 0; margin-top: 6px; }
    .detail-2col { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 480px) {
    .container { padding: 16px; }
    .dashboard { grid-template-columns: repeat(2, 1fr); }
    .signal-prices { grid-template-columns: repeat(2, 1fr); }
    .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    h1 { font-size: 1.4em; }
    .date-label { font-size: 1.1em; }
}
</style>
</head>
<body>
<div class="container">

<!-- Top Nav -->
<div class="top-nav">
    <a href="index.html">&larr; 系統文件</a>
    <a href="index.html" class="brand">Sovereign V20</a>
    <a href="news.html">整點快報 &rarr;</a>
</div>

<h1>每日選股報告</h1>

<!-- Date Navigation -->
<div class="date-nav">
    <button id="btn-prev" onclick="navigate(-1)">&lsaquo;</button>
    <span class="date-label" id="current-date">載入中...</span>
    <button id="btn-next" onclick="navigate(1)">&rsaquo;</button>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
    <div class="stat-card">
        <div class="stat-label">V20 模式</div>
        <div class="stat-value" id="s-mode">--</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">滾動勝率</div>
        <div class="stat-value" id="s-rwr">--</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">累計勝率</div>
        <div class="stat-value" id="s-wr">--</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">總交易</div>
        <div class="stat-value" id="s-total">--</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">持倉中</div>
        <div class="stat-value" id="s-open">--</div>
    </div>
</div>

<!-- Trade History -->
<div class="section-title">交易歷史</div>
<div class="history" id="history"></div>

<!-- Recent Exits -->
<div id="exits-section" style="display:none">
    <h2>今日結束 <span class="dim" id="exit-count"></span></h2>
    <div id="exits"></div>
</div>

<!-- Open Trades -->
<h2>持倉中 <span class="dim" id="open-label"></span></h2>
<div class="trades-grid" id="open-trades"></div>

<!-- Signal -->
<h2>今日首選訊號</h2>
<div id="signal"></div>

<!-- All Picks Detail -->
<h2>全部候選股詳細報告 <span class="dim" id="pick-count"></span></h2>
<div id="picks-detail"></div>

<!-- Quick Ref -->
<div id="quick-ref"></div>

<!-- All Picks Table -->
<h2>快速總覽表</h2>
<div class="table-wrap" id="picks-table"></div>

<!-- Footer -->
<div class="footer">
    <a href="index.html">&larr; 系統文件</a> &nbsp;|&nbsp; <a href="news.html">整點快報 &rarr;</a>
    <p style="margin-top:8px">Sovereign V20 &mdash; 動能突破交易系統</p>
</div>

</div>

<script>
/* ═══════════════════════════════════════════════════
   Sovereign V20 Daily Picks — Full Scanner Report
   ═══════════════════════════════════════════════════ */

// ── Strategy Parameters (constants) ─────────────
const PARAMS = {
    breakeven_trigger: 0.005,
    trail_activation: 0.018,
    trail_distance: 0.031,
    gap_reject_pct: 0.03,
    tp_target: 0.12,
    stale_days: 9,
    stale_threshold: -0.05,
    time_stop: 14,
    max_loss: -0.20,
    atr_sl: 2.4,
    slippage: 0.001,
};

let dateIndex = [];
let currentIdx = 0;

// ── Helpers ──────────────────────────────────────
function gradeColor(g) {
    return { A:'#4ecb71', B:'#8be9a0', C:'#ffd93d', D:'#ff9f43', F:'#ff6b6b' }[g] || '#8b90a5';
}

function gradeDesc(g) {
    return { A:'強勢突破訊號', B:'品質良好', C:'普通 - 謹慎操作', D:'品質偏低', F:'不建議操作' }[g] || '';
}

function fmt(n, d) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toFixed(d === undefined ? 2 : d);
}

function pct(n, d) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toFixed(d === undefined ? 1 : d) + '%';
}

async function fetchJSON(url) {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return resp.json();
}

function $(id) { return document.getElementById(id); }

// ── Quality Assessment (mirrors scanner logic) ──
function assessQuality(p) {
    const vol = p.vol_ratio || 0;
    const pct52 = p.pct_from_52wk || 0;
    const mom20 = p.mom_20 || 0;
    const rs = p.rs_rank || 0;
    const atr = p.atr || 0;
    const close = p.close || 1;
    const atr_pct = (atr / close) * 100;

    let score = 0;
    const signals = [];
    const red_flags = [];

    // 1. Volume Ratio (20pts)
    if (vol >= 1.7 && vol < 2.0) {
        score += 20; signals.push(['量比', fmt(vol,1)+'x', 20, 20, '1.7-2.0 最佳區間 (勝率83%)']);
    } else if (vol >= 1.5 && vol < 1.7) {
        score += 12; signals.push(['量比', fmt(vol,1)+'x', 12, 20, '溫和放量']);
    } else if (vol >= 2.0 && vol < 2.5) {
        score += 8; signals.push(['量比', fmt(vol,1)+'x', 8, 20, '偏高']);
    } else if (vol >= 2.5 && vol < 3.0) {
        score += 0; signals.push(['量比', fmt(vol,1)+'x', 0, 20, '危險: 2.5-3.0x 勝率僅36%']);
        red_flags.push('量比 2.5-3.0x (勝率36%)');
    } else if (vol >= 3.0 && vol < 5.0) {
        score += 5; signals.push(['量比', fmt(vol,1)+'x', 5, 20, '偏高但不確定']);
    } else {
        score += 10; signals.push(['量比', fmt(vol,1)+'x', 10, 20, '極端放量']);
    }

    // 2. 52-week proximity (20pts)
    if (pct52 >= 95 && pct52 < 100) {
        score += 20; signals.push(['52周接近度', fmt(pct52,0)+'%', 20, 20, '95-100% 最佳 (勝率84.6%)']);
    } else if (pct52 >= 100) {
        score += 10; signals.push(['52周接近度', fmt(pct52,0)+'%', 10, 20, '已在52周高點 (勝率65%)']);
    } else if (pct52 >= 85 && pct52 < 95) {
        score += 5; signals.push(['52周接近度', fmt(pct52,0)+'%', 5, 20, '85-95% 勝率約52%']);
    } else if (pct52 >= 80 && pct52 < 85) {
        score += 2; signals.push(['52周接近度', fmt(pct52,0)+'%', 2, 20, '危險: 80-85% 勝率僅47%']);
        red_flags.push('52周 ' + fmt(pct52,0) + '% (勝率47%)');
    } else {
        score += 8; signals.push(['52周接近度', fmt(pct52,0)+'%', 8, 20, '70-80% 區間']);
    }

    // 3. 20-day momentum (15pts)
    if (mom20 >= 10 && mom20 < 20) {
        score += 15; signals.push(['20日動能', (mom20>=0?'+':'')+fmt(mom20,1)+'%', 15, 15, '10-20% 最佳 (勝率78.6%)']);
    } else if (mom20 >= 5 && mom20 < 10) {
        score += 10; signals.push(['20日動能', (mom20>=0?'+':'')+fmt(mom20,1)+'%', 10, 15, '溫和動能']);
    } else if (mom20 >= 20 && mom20 < 30) {
        score += 8; signals.push(['20日動能', '+'+fmt(mom20,1)+'%', 8, 15, '偏強']);
    } else if (mom20 >= 30 && mom20 < 50) {
        score += 5; signals.push(['20日動能', '+'+fmt(mom20,1)+'%', 5, 15, '過熱中']);
    } else if (mom20 >= 50) {
        score += 2; signals.push(['20日動能', '+'+fmt(mom20,1)+'%', 2, 15, '嚴重過熱 >50%']);
        red_flags.push('20日動能 ' + fmt(mom20,0) + '% 嚴重過熱');
    } else {
        score += 6; signals.push(['20日動能', (mom20>=0?'+':'')+fmt(mom20,1)+'%', 6, 15, '0-5% 區間']);
    }

    // 4. RS Rank (15pts)
    if (rs >= 25 && rs <= 50) {
        score += 15; signals.push(['RS排名', '#'+rs, 15, 15, '25-50 最佳區間 (勝率80.3%)']);
    } else if (rs >= 11 && rs < 25) {
        score += 10; signals.push(['RS排名', '#'+rs, 10, 15, '強勢']);
    } else if (rs > 50 && rs <= 100) {
        score += 7; signals.push(['RS排名', '#'+rs, 7, 15, '中等']);
    } else if (rs >= 1 && rs < 11) {
        score += 5; signals.push(['RS排名', '#'+rs, 5, 15, '前10名 勝率59%']);
    } else {
        score += 3; signals.push(['RS排名', '#'+rs, 3, 15, 'RS偏弱']);
    }

    // 5. Volatility ATR/Price (10pts)
    if (atr_pct < 5) {
        score += 10; signals.push(['波動率', fmt(atr_pct,1)+'%', 10, 10, '<5% 低波動 (勝率72%)']);
    } else if (atr_pct < 7) {
        score += 6; signals.push(['波動率', fmt(atr_pct,1)+'%', 6, 10, '中等波動']);
    } else {
        score += 3; signals.push(['波動率', fmt(atr_pct,1)+'%', 3, 10, '高波動']);
    }

    // Extra red flag
    if (rs < 11 && pct52 < 95) {
        red_flags.push('RS ' + rs + ' 過熱但未接近高點');
    }

    return { score, signals, red_flags };
}

// ── Advanced Indicator Analysis ─────────────────
function rsiAnalysis(rsi) {
    if (rsi >= 55 && rsi <= 80) return { color: 'var(--green)', note: '最佳區間 (55-80)' };
    if (rsi > 80) return { color: 'var(--red)', note: '過熱風險' };
    if (rsi < 50) return { color: 'var(--red)', note: '動能不足' };
    return { color: 'var(--yellow)', note: '可接受' };
}

function cpAnalysis(cp) {
    if (cp > 70) return { color: 'var(--green)', note: '收在高點區 (強勢)' };
    if (cp > 50) return { color: 'var(--yellow)', note: '收在中間區' };
    return { color: 'var(--red)', note: '收在低點區 (弱勢)' };
}

function vzAnalysis(vz) {
    if (vz >= 3) return { color: 'var(--green)', note: '機構級量能 (Z>=3)' };
    if (vz >= 2) return { color: 'var(--green)', note: '強量能信號 (Z>=2)' };
    if (vz >= 1.5) return { color: 'var(--yellow)', note: '溫和放量' };
    return { color: 'var(--text)', note: '一般' };
}

// ── Init ─────────────────────────────────────────
async function init() {
    try {
        dateIndex = await fetchJSON('data/index.json');
    } catch (e) {
        showState('data/index.json 不存在', '請先執行 push_picks.py 生成資料');
        return;
    }
    if (!dateIndex || dateIndex.length === 0) {
        showState('尚無選股資料', '請先執行 push_picks.py 生成資料');
        return;
    }
    const hash = window.location.hash.slice(1);
    currentIdx = hash ? Math.max(dateIndex.indexOf(hash), 0) : 0;
    await loadDate();
}

async function loadDate() {
    const date = dateIndex[currentIdx];
    $('current-date').textContent = date;
    window.location.hash = date;
    $('btn-prev').disabled = currentIdx >= dateIndex.length - 1;
    $('btn-next').disabled = currentIdx <= 0;

    try {
        const data = await fetchJSON(`data/${date}.json`);
        renderAll(data);
    } catch (e) {
        showState('資料載入失敗', `無法讀取 data/${date}.json`);
    }
}

function navigate(dir) {
    const newIdx = currentIdx - dir;
    if (newIdx < 0 || newIdx >= dateIndex.length) return;
    currentIdx = newIdx;
    loadDate();
}

// ── Render All ───────────────────────────────────
function renderAll(data) {
    renderDashboard(data);
    renderHistory(data.performance ? data.performance.trade_history : []);
    renderExits(data.recent_exits || []);
    renderOpenTrades(data.open_trades || []);
    const picks = data.picks || [];
    renderSignal(picks[0], data.v20);
    renderPicksDetail(picks, data.v20);
    renderPicks(picks);
    renderQuickRef();
}

// ── Dashboard ────────────────────────────────────
function renderDashboard(data) {
    const v = data.v20 || {};
    const p = data.performance || {};

    const modeEl = $('s-mode');
    modeEl.textContent = v.label || '--';
    modeEl.style.color = v.mode === 'TP' ? 'var(--green)' : 'var(--orange)';

    $('s-rwr').textContent = v.rolling_wr != null ? pct(v.rolling_wr) : '--';
    $('s-rwr').style.color = v.rolling_wr != null ? (v.rolling_wr >= 58 ? 'var(--green)' : 'var(--orange)') : '';

    $('s-wr').textContent = p.win_rate != null ? pct(p.win_rate) : '--';
    $('s-wr').style.color = p.win_rate >= 60 ? 'var(--green)' : p.win_rate >= 50 ? 'var(--yellow)' : 'var(--red)';

    $('s-total').textContent = p.total_trades != null ? `${p.total_trades}` : '--';
    $('s-total').style.color = 'var(--text)';

    $('s-open').textContent = `${(data.open_trades || []).length}`;
    $('s-open').style.color = 'var(--accent2)';
}

// ── Trade History ────────────────────────────────
function renderHistory(history) {
    const el = $('history');
    if (!history || history.length === 0) {
        el.innerHTML = '<span style="color:var(--text-dim);font-size:0.9em">尚無交易紀錄</span>';
        return;
    }
    const recent = history.slice(-20);
    const offset = history.length - recent.length;
    el.innerHTML = recent.map((r, i) =>
        `<div class="dot dot-${r.toLowerCase()}" title="第 ${offset+i+1} 筆: ${r === 'W' ? '獲利' : '虧損'}">${r}</div>`
    ).join('');
}

// ── Recent Exits ─────────────────────────────────
function renderExits(exits) {
    const section = $('exits-section');
    if (!exits || exits.length === 0) {
        section.style.display = 'none';
        return;
    }
    section.style.display = 'block';
    $('exit-count').textContent = `(${exits.length} 筆)`;

    $('exits').innerHTML = exits.map(e => {
        const isWin = e.return_pct >= 0;
        const color = isWin ? 'var(--green)' : 'var(--red)';
        const reasonHex = { TP:'#4ecb71', TRAIL:'#4ecdc4', SL:'#ff6b6b', TIME:'#ffd93d', STALE:'#ff9f43' };
        const rc = reasonHex[e.exit_reason] || '#8b90a5';
        return `<div class="exit-card">
            <span class="exit-symbol">${e.symbol}</span>
            <span class="exit-reason" style="background:${rc}22;color:${rc}">${e.exit_reason}</span>
            <span class="exit-return" style="color:${color}">${isWin ? '+' : ''}${fmt(e.return_pct)}%</span>
            <span style="color:var(--text-dim);font-size:0.85em">$${fmt(e.entry_price)} &rarr; $${fmt(e.exit_price)}</span>
        </div>`;
    }).join('');
}

// ── Open Trades ──────────────────────────────────
function renderOpenTrades(trades) {
    $('open-label').textContent = trades.length > 0 ? `(${trades.length} 筆)` : '';

    if (trades.length === 0) {
        $('open-trades').innerHTML = '<div style="color:var(--text-dim);padding:16px">目前無持倉</div>';
        return;
    }

    $('open-trades').innerHTML = trades.map(t => {
        const modeClass = t.use_tp ? 'mode-tp' : 'mode-notp';
        const modeLabel = t.use_tp ? 'TP' : 'NoTP';
        return `<div class="trade-card">
            <div class="trade-header">
                <span class="trade-symbol">${t.symbol}</span>
                <span class="trade-mode ${modeClass}">${modeLabel}</span>
            </div>
            <div class="trade-days">Day ${t.days} | 進場 ${t.entry_date}</div>
            <div class="trade-prices">
                <span class="lbl">進場</span><span class="val">$${fmt(t.entry_price)}</span>
                <span class="lbl" style="color:var(--green)">停利</span><span class="val">$${fmt(t.tp)}</span>
                <span class="lbl" style="color:var(--red)">停損</span><span class="val">$${fmt(t.sl)}</span>
                <span class="lbl">最高</span><span class="val">$${fmt(t.highest)}</span>
            </div>
            <div class="trade-status">
                <span>BE: <span class="${t.be_set ? 'on' : 'off'}">${t.be_set ? 'ON' : 'OFF'}</span></span>
                <span>Trail: <span class="${t.trail_on ? 'on' : 'off'}">${t.trail_on ? 'ON' : 'OFF'}</span></span>
            </div>
        </div>`;
    }).join('');
}

// ── Build Operation Plan HTML ────────────────────
function buildPlanHTML(p) {
    const entry = p.entry_price;
    const close = p.close;
    const gap_threshold = close * (1 - PARAMS.gap_reject_pct);
    const be_price = entry * (1 + PARAMS.breakeven_trigger);
    const trail_price = entry * (1 + PARAMS.trail_activation);

    return `
    <div class="plan-section">
        <div class="plan-title">操作計畫</div>
        <ol class="plan-steps">
            <li><span class="step-num">1</span><span class="step-text">明日開盤檢查: 開盤價 &ge; $${fmt(gap_threshold)} 才進場</span></li>
        </ol>
        <div class="plan-warn">&raquo; 若開盤 &lt; $${fmt(gap_threshold)} (跳空 &gt;3%)，放棄本次訊號</div>
        <ol class="plan-steps" start="2">
            <li><span class="step-num">2</span><span class="step-text">進場買進 @ ~$${fmt(entry)}</span></li>
            <li><span class="step-num">3</span><span class="step-text">設定停損 @ <span style="color:var(--red)">$${fmt(p.sl_price)}</span></span></li>
            <li><span class="step-num">4</span><span class="step-text">漲 +${(PARAMS.breakeven_trigger*100).toFixed(1)}% (<span style="color:var(--accent2)">$${fmt(be_price)}</span>) &rarr; 停損移至成本價 (保本)</span></li>
            <li><span class="step-num">5</span><span class="step-text">漲 +${(PARAMS.trail_activation*100).toFixed(1)}% (<span style="color:var(--accent2)">$${fmt(trail_price)}</span>) &rarr; 啟動 ${(PARAMS.trail_distance*100).toFixed(1)}% 追蹤停損</span></li>
            <li><span class="step-num">6</span><span class="step-text">停利 @ <span style="color:var(--green)">$${fmt(p.tp_price)}</span> (+${(PARAMS.tp_target*100).toFixed(0)}%)</span></li>
            <li><span class="step-num">7</span><span class="step-text">持倉 ${PARAMS.stale_days} 天若仍虧損 &gt;${Math.abs(PARAMS.stale_threshold*100).toFixed(0)}%，收盤出場 (停滯出場)</span></li>
            <li><span class="step-num">8</span><span class="step-text">最長持有 ${PARAMS.time_stop} 個交易日，到期收盤出場</span></li>
        </ol>
    </div>`;
}

// ── Build Quality Analysis HTML ──────────────────
function buildQualityHTML(p) {
    const qa = assessQuality(p);

    const rows = qa.signals.map(([name, val, pts, max, reason]) => {
        const c = pts >= max * 0.7 ? 'var(--green)' : pts >= max * 0.4 ? 'var(--yellow)' : 'var(--red)';
        return `<tr>
            <td>${name}</td>
            <td class="num">${val}</td>
            <td class="qa-score" style="color:${c}">${pts}/${max}</td>
            <td class="qa-reason">${reason}</td>
        </tr>`;
    }).join('');

    let flagsHTML = '';
    if (qa.red_flags.length > 0) {
        flagsHTML = `<div class="red-flags">
            <div class="red-flags-title">紅旗警告</div>
            <ul>${qa.red_flags.map(f => `<li>${f}</li>`).join('')}</ul>
        </div>`;
    } else if (p.quality_score >= 65) {
        flagsHTML = '<div class="no-flags">無紅旗警告，品質訊號良好。</div>';
    }

    return `
    <div class="qa-section">
        <div class="plan-title">突破品質分析</div>
        <table class="qa-table">
            <thead><tr>
                <th>訊號</th>
                <th class="num">數值</th>
                <th class="num">得分</th>
                <th>分析</th>
            </tr></thead>
            <tbody>${rows}</tbody>
        </table>
        ${flagsHTML}
    </div>`;
}

// ── Build Advanced Indicators HTML ───────────────
function buildAdvancedHTML(p) {
    const rsi = p.rsi_14 || 0;
    const cp = p.close_position || 0;
    const vz = p.vol_zscore || 0;

    const ra = rsiAnalysis(rsi);
    const ca = cpAnalysis(cp);
    const va = vzAnalysis(vz);

    return `
    <div class="adv-section">
        <div class="plan-title">進階指標</div>
        <div class="adv-row">
            <span class="adv-label">RSI(14)</span>
            <span class="adv-value" style="color:${ra.color}">${fmt(rsi, 1)}</span>
            <span class="adv-note">${ra.note}</span>
        </div>
        <div class="adv-row">
            <span class="adv-label">K線品質</span>
            <span class="adv-value" style="color:${ca.color}">${fmt(cp, 0)}%</span>
            <span class="adv-note">${ca.note}</span>
        </div>
        <div class="adv-row">
            <span class="adv-label">量能Z分</span>
            <span class="adv-value" style="color:${va.color}">${fmt(vz, 1)}\u03c3</span>
            <span class="adv-note">${va.note}</span>
        </div>
    </div>`;
}

// ── Signal Card (#1 Pick - Full Report) ──────────
function renderSignal(pick, v20) {
    if (!pick) {
        $('signal').innerHTML = '<div style="color:var(--text-dim);padding:16px">今日無候選股</div>';
        return;
    }
    const gc = gradeColor(pick.quality_grade);
    const rr = pick.risk_pct > 0 ? (pick.reward_pct / pick.risk_pct).toFixed(2) : '--';
    const position_val = (pick.shares * pick.entry_price).toFixed(0);

    $('signal').innerHTML = `
    <div class="signal-card">
        <div class="signal-top">
            <span class="signal-symbol">${pick.symbol}</span>
            <span class="signal-grade" style="background:${gc}22;color:${gc}">
                ${pick.quality_grade} ${pick.quality_score.toFixed(0)}分
            </span>
            <span class="signal-desc">${gradeDesc(pick.quality_grade)}</span>
        </div>
        <div class="signal-sector">${pick.sector} &mdash; 板塊排名 #${pick.sector_rank}</div>

        <div class="signal-prices">
            <div class="price-box">
                <div class="p-label">收盤</div>
                <div class="p-value">$${fmt(pick.close)}</div>
            </div>
            <div class="price-box">
                <div class="p-label">進場</div>
                <div class="p-value">$${fmt(pick.entry_price)}</div>
            </div>
            <div class="price-box" style="border:1px solid var(--green)">
                <div class="p-label" style="color:var(--green)">停利</div>
                <div class="p-value" style="color:var(--green)">$${fmt(pick.tp_price)}</div>
            </div>
            <div class="price-box" style="border:1px solid var(--red)">
                <div class="p-label" style="color:var(--red)">停損</div>
                <div class="p-value" style="color:var(--red)">$${fmt(pick.sl_price)}</div>
            </div>
        </div>

        <div class="signal-risk">
            風險 <span style="color:var(--red)">${fmt(pick.risk_pct)}%</span>
            &nbsp;|&nbsp;
            報酬 <span style="color:var(--green)">${fmt(pick.reward_pct)}%</span>
            &nbsp;|&nbsp;
            盈虧比 <span style="color:var(--accent)">${rr}</span>
            &nbsp;|&nbsp;
            股數 <span style="color:var(--accent)">${pick.shares}</span>
            &nbsp;|&nbsp;
            部位 <span style="color:var(--accent)">$${Number(position_val).toLocaleString()}</span>
        </div>

        <div class="metrics-grid">
            ${mk('RS 排名', '#' + pick.rs_rank)}
            ${mk('量比', fmt(pick.vol_ratio) + 'x')}
            ${mk('盤整度', fmt(pick.tightness))}
            ${mk('RSI', fmt(pick.rsi_14, 1))}
            ${mk('20日動能', pct(pick.mom_20, 1))}
            ${mk('均線斜率', fmt(pick.sma20_slope, 4))}
            ${mk('52W接近度', pct(pick.pct_from_52wk, 1))}
            ${mk('量能Z', fmt(pick.vol_zscore))}
            ${mk('K線品質', pct(pick.close_position, 1))}
            ${mk('ATR', '$' + fmt(pick.atr))}
        </div>

        ${buildPlanHTML(pick)}
        ${buildQualityHTML(pick)}
        ${buildAdvancedHTML(pick)}
    </div>`;
}

function mk(label, value) {
    return `<div class="metric"><div class="m-label">${label}</div><div class="m-value">${value}</div></div>`;
}

// ── All Picks Detail Cards ──────────────────────
function renderPicksDetail(picks, v20) {
    $('pick-count').textContent = `(${picks.length} 檔)`;

    if (!picks || picks.length === 0) {
        $('picks-detail').innerHTML = '<div style="color:var(--text-dim);padding:16px">今日無候選股</div>';
        return;
    }

    // Skip #1 (already shown in signal card) - show #2 onwards
    const rest = picks.slice(1);
    if (rest.length === 0) {
        $('picks-detail').innerHTML = '<div style="color:var(--text-dim);padding:16px;font-size:0.9em">今日僅一檔候選股 (已顯示於上方)</div>';
        return;
    }

    $('picks-detail').innerHTML = rest.map(p => {
        const gc = gradeColor(p.quality_grade);
        const rr = p.risk_pct > 0 ? (p.reward_pct / p.risk_pct).toFixed(2) : '--';
        const gap_threshold = p.close * (1 - PARAMS.gap_reject_pct);
        const be_price = p.entry_price * (1 + PARAMS.breakeven_trigger);
        const trail_price = p.entry_price * (1 + PARAMS.trail_activation);
        const position_val = (p.shares * p.entry_price).toFixed(0);

        return `<div class="pick-detail-card" onclick="this.classList.toggle('open')">
            <div class="pick-detail-header">
                <span class="pick-detail-rank">${p.rank}</span>
                <span class="pick-detail-sym">${p.symbol}</span>
                <span class="grade-badge" style="background:${gc}22;color:${gc}">${p.quality_grade} ${p.quality_score.toFixed(0)}分</span>
                <span style="color:var(--text-dim);font-size:0.85em">${p.sector} #${p.sector_rank}</span>
                <span class="pick-detail-toggle">[點擊展開]</span>
                <span class="pick-detail-prices">
                    <span>$${fmt(p.close)}</span>
                    <span style="color:var(--green)">TP $${fmt(p.tp_price)}</span>
                    <span style="color:var(--red)">SL $${fmt(p.sl_price)}</span>
                </span>
            </div>
            <div class="pick-detail-body">
                <div class="detail-2col">
                    <span class="d-lbl">股價</span><span class="d-val">$${fmt(p.close)}</span>
                    <span class="d-lbl">進場價</span><span class="d-val">$${fmt(p.entry_price)}</span>
                    <span class="d-lbl">RS排名</span><span class="d-val">${p.rs_rank}</span>
                    <span class="d-lbl" style="color:var(--green)">停利</span><span class="d-val" style="color:var(--green)">$${fmt(p.tp_price)} (+${fmt(p.reward_pct)}%)</span>
                    <span class="d-lbl">量比</span><span class="d-val">${fmt(p.vol_ratio)}x</span>
                    <span class="d-lbl" style="color:var(--red)">停損</span><span class="d-val" style="color:var(--red)">$${fmt(p.sl_price)} (-${fmt(p.risk_pct)}%)</span>
                    <span class="d-lbl">52周</span><span class="d-val">${pct(p.pct_from_52wk, 1)}</span>
                    <span class="d-lbl">盈虧比</span><span class="d-val">${rr}</span>
                    <span class="d-lbl">20日動能</span><span class="d-val">${pct(p.mom_20, 1)}</span>
                    <span class="d-lbl">股數</span><span class="d-val">${p.shares}</span>
                    <span class="d-lbl">盤整度</span><span class="d-val">${fmt(p.tightness)}</span>
                    <span class="d-lbl">部位</span><span class="d-val">$${Number(position_val).toLocaleString()}</span>
                    <span class="d-lbl">SMA20斜率</span><span class="d-val">${fmt(p.sma20_slope, 4)}</span>
                    <span class="d-lbl">ATR</span><span class="d-val">$${fmt(p.atr)}</span>
                </div>
                ${buildPlanHTML(p)}
                ${buildQualityHTML(p)}
                ${buildAdvancedHTML(p)}
            </div>
        </div>`;
    }).join('');
}

// ── Quick Reference ─────────────────────────────
function renderQuickRef() {
    $('quick-ref').innerHTML = `
    <div class="quick-ref">
        <div class="quick-ref-title">快速參考</div>
        <div class="quick-ref-row">
            <span class="qr-label" style="color:var(--green)">最佳訊號:</span>
            <span class="qr-items">量比 1.7-2.0x (83%) | 52周 95-100% (85%) | 20日動能 10-20% (79%) | RS 25-50名 (80%)</span>
        </div>
        <div class="quick-ref-row">
            <span class="qr-label" style="color:var(--red)">紅旗警告:</span>
            <span class="qr-items">量比 2.5-3.0x (36%) | 5日動能 &lt;-5% (40%) | 52周 80-85% (47%) | 跳空 &gt;10% (33%)</span>
        </div>
        <div class="quick-ref-row">
            <span class="qr-label" style="color:var(--accent)">操作參數:</span>
            <span class="qr-items">保本 +0.5% | 追蹤 +1.8% (3.1%) | 停利 +12% | 停滯 9天&gt;5% | 時間停 14天 | 跳空拒絕 3%</span>
        </div>
    </div>`;
}

// ── Picks Table (Quick Overview) ─────────────────
function renderPicks(picks) {
    if (!picks || picks.length === 0) {
        $('picks-table').innerHTML = '<div style="color:var(--text-dim);padding:16px">今日無候選股</div>';
        return;
    }

    const rows = picks.map(p => {
        const gc = gradeColor(p.quality_grade);
        const rr = p.risk_pct > 0 ? (p.reward_pct / p.risk_pct).toFixed(1) : '--';
        return `<tr>
            <td class="num">${p.rank}</td>
            <td><strong>${p.symbol}</strong></td>
            <td><span class="grade-badge" style="background:${gc}22;color:${gc}">${p.quality_grade}</span></td>
            <td class="num">${p.quality_score.toFixed(0)}</td>
            <td>${p.sector}</td>
            <td class="num">$${fmt(p.close)}</td>
            <td class="num">$${fmt(p.entry_price)}</td>
            <td class="num" style="color:var(--green)">$${fmt(p.tp_price)}</td>
            <td class="num" style="color:var(--red)">$${fmt(p.sl_price)}</td>
            <td class="num">${fmt(p.risk_pct)}%</td>
            <td class="num">${rr}</td>
            <td class="num">${p.rs_rank}</td>
            <td class="num">${fmt(p.vol_ratio)}</td>
            <td class="num">${fmt(p.rsi_14, 1)}</td>
            <td class="num">${pct(p.mom_20, 1)}</td>
            <td class="num">${pct(p.pct_from_52wk, 1)}</td>
        </tr>`;
    }).join('');

    $('picks-table').innerHTML = `<table>
        <thead><tr>
            <th class="num">#</th>
            <th>代碼</th>
            <th>評級</th>
            <th class="num">分數</th>
            <th>板塊</th>
            <th class="num">收盤</th>
            <th class="num">進場</th>
            <th class="num">停利</th>
            <th class="num">停損</th>
            <th class="num">風險%</th>
            <th class="num">R:R</th>
            <th class="num">RS</th>
            <th class="num">量比</th>
            <th class="num">RSI</th>
            <th class="num">動能</th>
            <th class="num">52W%</th>
        </tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
}

// ── State Messages ───────────────────────────────
function showState(title, desc) {
    $('history').innerHTML = '';
    $('exits-section').style.display = 'none';
    $('open-trades').innerHTML = '';
    $('open-label').textContent = '';
    $('picks-table').innerHTML = '';
    $('picks-detail').innerHTML = '';
    $('pick-count').textContent = '';
    $('quick-ref').innerHTML = '';
    ['s-mode','s-rwr','s-wr','s-total','s-open'].forEach(id => { $(id).textContent = '--'; $(id).style.color = ''; });
    $('signal').innerHTML = `<div class="state-msg">
        <div class="icon">&#x1F4CA;</div>
        <p><strong>${title}</strong></p>
        <p style="margin-top:8px;font-size:0.9em">${desc}</p>
    </div>`;
}

// ── Bootstrap ────────────────────────────────────
init();
window.addEventListener('hashchange', () => {
    const hash = window.location.hash.slice(1);
    const idx = dateIndex.indexOf(hash);
    if (idx >= 0 && idx !== currentIdx) {
        currentIdx = idx;
        loadDate();
    }
});
</script>

</body>
</html>
