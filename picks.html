<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sovereign - 每日選股報告</title>
<meta name="description" content="Sovereign 動能突破交易系統每日選股報告 — 全自動美股掃描、品質評級、TP/NoTP 動態操作計畫">
<style>
:root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #222633;
    --border: #2d3148;
    --text: #e1e4ed;
    --text-dim: #8b90a5;
    --accent: #6c8cff;
    --accent2: #4ecdc4;
    --green: #4ecb71;
    --red: #ff6b6b;
    --yellow: #ffd93d;
    --orange: #ff9f43;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    font-size: 15px;
}
.container { max-width: 1080px; margin: 0 auto; padding: 24px; }

/* ── Top Nav ── */
.top-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 8px;
}
.top-nav a {
    color: var(--accent);
    text-decoration: none;
    font-size: 0.9em;
}
.top-nav a:hover { text-decoration: underline; }
.top-nav .brand {
    font-weight: 700;
    color: var(--text-dim);
    font-size: 0.9em;
}
.top-nav .brand:hover { color: var(--text); text-decoration: none; }
.nav-links { display: flex; gap: 16px; flex-wrap: wrap; }
.nav-links a.active { color: var(--text); font-weight: 600; }

/* ── Stale Banner ── */
.stale-banner {
    background: linear-gradient(135deg, #ff9f43, #ee5a24);
    color: #fff;
    padding: 10px 20px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    margin-bottom: 16px;
    position: relative;
    display: none;
}
.stale-banner .close-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255,255,255,0.8);
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
}
.stale-banner .close-btn:hover { color: #fff; }

/* ── Title ── */
h1 {
    font-size: 1.8em;
    text-align: center;
    margin-bottom: 24px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* ── Date Navigation ── */
.date-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-bottom: 28px;
}
.date-nav button {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--accent);
    width: 40px;
    height: 40px;
    border-radius: 8px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background 0.2s;
}
.date-nav button:hover:not(:disabled) { background: var(--surface2); }
.date-nav button:disabled { opacity: 0.3; cursor: default; }
.date-label {
    font-size: 1.3em;
    font-weight: 700;
    color: var(--text);
    min-width: 160px;
    text-align: center;
}

/* ── Dashboard ── */
.dashboard {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
}
.stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
}
.stat-label {
    font-size: 0.8em;
    color: var(--text-dim);
    margin-bottom: 4px;
}
.stat-value {
    font-size: 1.35em;
    font-weight: 700;
}
.stat-desc {
    font-size: 0.7em;
    color: var(--text-dim);
    margin-top: 6px;
    line-height: 1.4;
    opacity: 0.8;
}

/* ── Trade History ── */
.section-title {
    font-size: 0.85em;
    color: var(--text-dim);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}


/* ── Section Headers ── */
h2 {
    font-size: 1.2em;
    color: var(--accent);
    margin: 28px 0 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}
h2 .dim { color: var(--text-dim); font-size: 0.85em; font-weight: 400; }

/* ── Open Trades Grid ── */
.trades-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
}
.trade-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
}
.trade-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.trade-symbol {
    font-size: 1.2em;
    font-weight: 700;
}
.trade-days {
    font-size: 0.85em;
    color: var(--text-dim);
}
.trade-mode {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.75em;
    font-weight: 600;
}
.mode-tp { background: rgba(78,203,113,0.2); color: var(--green); }
.mode-notp { background: rgba(255,159,67,0.2); color: var(--orange); }
.trade-prices {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    font-size: 0.9em;
    margin-top: 8px;
}
.trade-prices .lbl { color: var(--text-dim); }
.trade-prices .val { text-align: right; font-variant-numeric: tabular-nums; }
.trade-status {
    display: flex;
    gap: 10px;
    margin-top: 8px;
    font-size: 0.8em;
    color: var(--text-dim);
}
.trade-status .on { color: var(--green); }
.trade-status .off { color: var(--text-dim); }

/* ── NoTP Dashboard ── */
.notp-dashboard {
    margin-top: 12px;
    padding: 12px;
    background: rgba(255,159,67,0.06);
    border: 1px solid rgba(255,159,67,0.2);
    border-radius: 8px;
}
.notp-dashboard .dash-title {
    font-size: 0.8em;
    font-weight: 600;
    color: var(--orange);
    margin-bottom: 8px;
}
.notp-profit-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.notp-profit-pct {
    font-size: 1.3em;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
}
.notp-profit-pct.positive { color: var(--green); }
.notp-profit-pct.negative { color: var(--red); }
.notp-profit-pct.neutral  { color: var(--text-dim); }
.notp-trail-val {
    font-size: 0.85em;
    color: var(--text-dim);
}
.notp-trail-val strong { color: var(--orange); }
.notp-tier-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8em;
    margin-top: 6px;
}
.notp-tier-table th {
    background: rgba(255,159,67,0.1);
    color: var(--orange);
    padding: 4px 6px;
    font-weight: 600;
    font-size: 0.9em;
    border-bottom: 1px solid rgba(255,159,67,0.2);
    text-align: left;
}
.notp-tier-table td {
    padding: 4px 6px;
    border-bottom: 1px solid rgba(45,49,72,0.4);
    color: var(--text-dim);
}
.notp-tier-table tr.tier-active {
    background: rgba(255,159,67,0.12);
}
.notp-tier-table tr.tier-active td {
    color: var(--orange);
    font-weight: 600;
}
.notp-tier-table .tier-arrow {
    color: var(--orange);
    font-weight: 700;
    margin-right: 4px;
}
.notp-progress {
    display: flex;
    gap: 4px;
    margin-top: 10px;
    font-size: 0.75em;
    color: var(--text-dim);
    align-items: center;
}
.notp-progress .step {
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
}
.notp-progress .step.done {
    background: rgba(78,203,113,0.15);
    border-color: var(--green);
    color: var(--green);
}
.notp-progress .step.current {
    background: rgba(255,159,67,0.15);
    border-color: var(--orange);
    color: var(--orange);
}
.notp-progress .arrow { color: var(--border); }
.tp-profit-row {
    margin-top: 8px;
    font-size: 0.85em;
    color: var(--text-dim);
}
.tp-profit-row .pct { font-weight: 600; font-variant-numeric: tabular-nums; }
.tp-profit-row .pct.positive { color: var(--green); }
.tp-profit-row .pct.negative { color: var(--red); }

/* ── Exit Cards ── */
.exit-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 8px;
}
.exit-symbol { font-weight: 700; font-size: 1.1em; min-width: 60px; }
.exit-reason {
    padding: 1px 8px;
    border-radius: 10px;
    font-size: 0.8em;
    font-weight: 600;
}
.exit-return { font-weight: 700; font-variant-numeric: tabular-nums; }

/* ── Signal Card ── */
.signal-card {
    background: var(--surface);
    border: 2px solid var(--accent);
    border-radius: 14px;
    padding: 24px;
    position: relative;
    overflow: hidden;
}
.signal-card::before {
    content: '#1 SIGNAL';
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 0.7em;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 2px;
    opacity: 0.5;
}
.signal-top {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 6px;
}
.signal-symbol {
    font-size: 2em;
    font-weight: 800;
}
.signal-grade {
    padding: 4px 14px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.95em;
}
.signal-desc {
    font-size: 0.85em;
    color: var(--text-dim);
    margin-left: 4px;
}
.signal-sector {
    color: var(--text-dim);
    font-size: 0.9em;
    margin-bottom: 16px;
}
.signal-prices {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 14px;
}
.price-box {
    background: var(--surface2);
    border-radius: 8px;
    padding: 10px 12px;
    text-align: center;
}
.price-box .p-label {
    font-size: 0.75em;
    color: var(--text-dim);
    margin-bottom: 2px;
}
.price-box .p-value {
    font-size: 1.15em;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
}
.signal-risk {
    text-align: center;
    color: var(--text-dim);
    font-size: 0.9em;
    margin-bottom: 16px;
}
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}
.metric {
    background: var(--surface2);
    border-radius: 6px;
    padding: 8px;
    text-align: center;
}
.metric .m-label {
    font-size: 0.7em;
    color: var(--text-dim);
    margin-bottom: 2px;
}
.metric .m-value {
    font-size: 0.95em;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
}

/* ── Operation Plan ── */
.plan-section {
    margin-top: 20px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
}
.plan-title {
    font-size: 1em;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 12px;
}
.plan-steps {
    list-style: none;
    padding: 0;
}
.plan-steps li {
    padding: 6px 0;
    font-size: 0.9em;
    display: flex;
    gap: 8px;
}
.plan-steps .step-num {
    flex-shrink: 0;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--surface2);
    color: var(--accent);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75em;
    font-weight: 700;
}
.plan-steps .step-text {
    flex: 1;
}
.plan-warn {
    color: var(--red);
    font-size: 0.85em;
    padding-left: 30px;
    margin-top: -2px;
    margin-bottom: 4px;
}

/* ── Quality Analysis Table ── */
.qa-section {
    margin-top: 20px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
}
.qa-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
    margin-top: 8px;
}
.qa-table th {
    background: var(--surface2);
    color: var(--accent);
    padding: 8px 10px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border);
}
.qa-table td {
    padding: 7px 10px;
    border-bottom: 1px solid var(--border);
}
.qa-table .qa-score {
    font-weight: 700;
    text-align: center;
    font-variant-numeric: tabular-nums;
}
.qa-table .qa-reason {
    color: var(--text-dim);
    font-size: 0.92em;
}

/* ── Red Flags ── */
.red-flags {
    margin-top: 14px;
    padding: 12px 16px;
    background: rgba(255,107,107,0.08);
    border: 1px solid rgba(255,107,107,0.25);
    border-radius: 8px;
}
.red-flags-title {
    font-weight: 700;
    color: var(--red);
    font-size: 0.9em;
    margin-bottom: 6px;
}
.red-flags ul {
    list-style: none;
    padding: 0;
}
.red-flags li {
    font-size: 0.85em;
    color: var(--red);
    padding: 2px 0;
}
.red-flags li::before {
    content: '\27A4 ';
}
.no-flags {
    margin-top: 14px;
    padding: 10px 16px;
    background: rgba(78,203,113,0.08);
    border: 1px solid rgba(78,203,113,0.25);
    border-radius: 8px;
    font-size: 0.85em;
    color: var(--green);
}

/* ── Advanced Indicators ── */
.adv-section {
    margin-top: 20px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
}
.adv-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    font-size: 0.9em;
}
.adv-label {
    min-width: 90px;
    color: var(--text-dim);
    font-weight: 600;
}
.adv-value {
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    min-width: 60px;
}
.adv-note {
    color: var(--text-dim);
    font-size: 0.92em;
}

/* ── Mode Comparison Table ── */
.mode-compare {
    margin-top: 20px;
    padding-top: 18px;
    border-top: 1px solid var(--border);
}
.mode-compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 10px;
}
.mode-box {
    background: var(--surface2);
    border-radius: 10px;
    padding: 14px 16px;
    border: 2px solid transparent;
}
.mode-box.active {
    border-color: var(--accent);
}
.mode-box-title {
    font-weight: 700;
    font-size: 0.95em;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.mode-box-title .mode-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}
.mode-box ul {
    list-style: none;
    padding: 0;
    font-size: 0.85em;
    color: var(--text-dim);
}
.mode-box ul li {
    padding: 3px 0;
}
.mode-box ul li::before {
    content: '\2022 ';
    color: var(--accent);
}
.mode-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 8px;
    font-size: 0.85em;
    font-weight: 700;
    margin: 8px 0;
}
.mode-indicator.tp-mode {
    background: rgba(78,203,113,0.15);
    color: var(--green);
    border: 1px solid rgba(78,203,113,0.3);
}
.mode-indicator.notp-mode {
    background: rgba(255,159,67,0.15);
    color: var(--orange);
    border: 1px solid rgba(255,159,67,0.3);
}
.tiered-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82em;
    margin-top: 8px;
}
.tiered-table th {
    background: var(--surface);
    color: var(--accent);
    padding: 5px 8px;
    font-weight: 600;
    font-size: 0.9em;
    border-bottom: 1px solid var(--border);
}
.tiered-table td {
    padding: 4px 8px;
    border-bottom: 1px solid rgba(45,49,72,0.5);
    color: var(--text-dim);
}

/* ── Quick Reference ── */
.quick-ref {
    margin-top: 28px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
}
.quick-ref-title {
    font-size: 1em;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 10px;
}
.quick-ref-row {
    display: flex;
    gap: 8px;
    font-size: 0.88em;
    padding: 4px 0;
    align-items: baseline;
}
.quick-ref-row .qr-label {
    font-weight: 700;
    min-width: 80px;
    flex-shrink: 0;
}
.quick-ref-row .qr-items {
    color: var(--text-dim);
}

/* ── Pick Detail Card (expandable) ── */
.pick-detail-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 20px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: border-color 0.2s;
}
.pick-detail-card:hover {
    border-color: var(--accent);
}
.pick-detail-header {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.pick-detail-rank {
    font-size: 0.8em;
    font-weight: 700;
    color: var(--accent);
    background: var(--surface2);
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.pick-detail-sym {
    font-size: 1.2em;
    font-weight: 800;
}
.pick-detail-prices {
    display: flex;
    gap: 16px;
    margin-left: auto;
    font-size: 0.88em;
    font-variant-numeric: tabular-nums;
}
.pick-detail-body {
    display: none;
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
}
.pick-detail-card.open .pick-detail-body {
    display: block;
}
.pick-detail-card.open {
    border-color: var(--accent);
}
.pick-detail-toggle {
    font-size: 0.8em;
    color: var(--text-dim);
    margin-left: 8px;
}
.detail-2col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    font-size: 0.88em;
    margin-bottom: 12px;
}
.detail-2col .d-lbl { color: var(--text-dim); }
.detail-2col .d-val { text-align: right; font-variant-numeric: tabular-nums; }

/* ── Picks Table ── */
.table-wrap {
    overflow-x: auto;
    border-radius: 10px;
    border: 1px solid var(--border);
}
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88em;
    white-space: nowrap;
}
th {
    background: var(--surface2);
    color: var(--accent);
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border);
    position: sticky;
    top: 0;
}
td {
    padding: 9px 12px;
    border-bottom: 1px solid var(--border);
}
tr:hover td { background: rgba(108,140,255,0.05); }
.num { text-align: right; font-variant-numeric: tabular-nums; }
.grade-badge {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.85em;
}
tr:first-child td { background: rgba(108,140,255,0.08); }

/* ── Empty / Loading State ── */
.state-msg {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-dim);
}
.state-msg .icon { font-size: 2.5em; margin-bottom: 12px; }
.state-msg p { font-size: 1.05em; }

/* ── Footer ── */
.footer {
    margin-top: 48px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
    text-align: center;
    color: var(--text-dim);
    font-size: 0.85em;
}
.footer a {
    color: var(--accent);
    text-decoration: none;
}
.footer a:hover { text-decoration: underline; }

/* ── Responsive ── */
@media (max-width: 768px) {
    .container { padding: 16px; }
    .dashboard { grid-template-columns: repeat(3, 1fr); }
    .stat-desc { font-size: 0.65em; }
    .signal-prices { grid-template-columns: repeat(2, 1fr); }
    .metrics-grid { grid-template-columns: repeat(3, 1fr); }
    .trades-grid { grid-template-columns: 1fr; }
    .pick-detail-prices { margin-left: 0; margin-top: 6px; }
    .detail-2col { grid-template-columns: 1fr 1fr; }
    .exit-card { flex-wrap: wrap; gap: 8px; }
    .signal-risk { font-size: 0.8em; }
}
@media (max-width: 480px) {
    .container { padding: 12px; }
    .dashboard { grid-template-columns: repeat(2, 1fr); }
    .dashboard .stat-card:last-child {
        grid-column: 1 / -1;
    }
    .stat-value { font-size: 1.15em; }
    .signal-prices { grid-template-columns: repeat(2, 1fr); }
    .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    h1 { font-size: 1.4em; }
    .date-label { font-size: 1.1em; }
    .signal-symbol { font-size: 1.5em; }
    .signal-risk { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; }
    .quick-ref-row { flex-direction: column; gap: 4px; }
    .quick-ref-row .qr-label { min-width: auto; }
}

/* ── Accessibility ── */
:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
    border-radius: 4px;
}
:focus:not(:focus-visible) { outline: none; }
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        transition-duration: 0.01ms !important;
    }
}
</style>
</head>
<body>
<div class="container">

<!-- Top Nav -->
<div class="top-nav">
    <a href="index.html" class="brand">Sovereign V22</a>
    <div class="nav-links">
        <a href="picks.html" class="active">每日選股</a>
        <a href="track.html">選股追蹤</a>
        <a href="news.html">整點快報</a>
        <a href="evolution.html">版本演化</a>
    </div>
</div>

<div class="stale-banner" id="stale-banner">
    <span id="stale-msg"></span>
    <button class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
</div>

<h1>每日選股報告</h1>

<!-- Date Navigation -->
<div class="date-nav">
    <button id="btn-prev" onclick="navigate(-1)">&lsaquo;</button>
    <span class="date-label" id="current-date">載入中...</span>
    <button id="btn-next" onclick="navigate(1)">&rsaquo;</button>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
    <div class="stat-card">
        <div class="stat-label">動態模式</div>
        <div class="stat-value" id="s-mode">--</div>
        <div class="stat-desc">TP=固定停利，追蹤停損<br>NoTP=無停利，Tiered ATR 追蹤</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">滾動勝率</div>
        <div class="stat-value" id="s-rwr">--</div>
        <div class="stat-desc">近 20 筆交易勝率<br>&ge;55% 切 TP，&lt;55% 切 NoTP</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">首選評級</div>
        <div class="stat-value" id="s-grade">--</div>
        <div class="stat-desc">今日 #1 選股<br>品質等級</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">今日候選</div>
        <div class="stat-value" id="s-count">--</div>
        <div class="stat-desc">通過篩選條件<br>的候選股數量</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">持倉中</div>
        <div class="stat-value" id="s-open">--</div>
        <div class="stat-desc">目前未結束<br>的交易數量</div>
    </div>
</div>

<!-- Recent Exits -->
<div id="exits-section" style="display:none">
    <h2>今日結束 <span class="dim" id="exit-count"></span></h2>
    <div id="exits"></div>
</div>

<!-- Open Trades -->
<h2>持倉中 <span class="dim" id="open-label"></span></h2>
<div class="trades-grid" id="open-trades"></div>

<!-- Signal -->
<h2>今日首選訊號</h2>
<div id="signal"></div>

<!-- All Picks Detail -->
<h2>全部候選股詳細報告 <span class="dim" id="pick-count"></span></h2>
<div id="picks-detail"></div>

<!-- Quick Ref -->
<div id="quick-ref"></div>

<!-- All Picks Table -->
<h2>快速總覽表</h2>
<div class="table-wrap" id="picks-table"></div>

<!-- Footer -->
<div class="footer">
    <a href="index.html">&larr; 系統文件</a> &nbsp;|&nbsp;
    <a href="track.html">選股追蹤</a> &nbsp;|&nbsp;
    <a href="news.html">整點快報 &rarr;</a>
    <p style="margin-top:8px">Sovereign &mdash; 動能突破交易系統 (V22 動態切換)</p>
</div>

</div>

<script>
/* ═══════════════════════════════════════════════════
   Sovereign V22 Daily Picks — Full Scanner Report
   ═══════════════════════════════════════════════════ */

// ── Strategy Parameters (constants) ─────────────
const PARAMS = {
    breakeven_trigger: 0.008,
    trail_activation: 0.018,
    trail_distance: 0.031,
    gap_reject_pct: 0.03,
    tp_target: 0.15,
    stale_days: 9,
    stale_threshold: -0.05,
    time_stop: 10,
    max_loss: -0.20,
    atr_sl: 1.3,
    slippage: 0.001,
};

let dateIndex = [];
let currentIdx = 0;

// ── Helpers ──────────────────────────────────────
function escHtml(str) {
    if (str == null) return '';
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
}

function gradeColor(g) {
    return { S:'#ffd700', A:'#4ecb71', B:'#8be9a0', C:'#ffd93d', D:'#ff9f43', F:'#ff6b6b' }[g] || '#8b90a5';
}

function gradeDesc(g) {
    return { S:'頂級突破訊號', A:'強勢突破訊號', B:'品質良好', C:'普通 - 謹慎操作', D:'品質偏低', F:'不建議操作' }[g] || '';
}

function fmt(n, d) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toFixed(d === undefined ? 2 : d);
}

function pct(n, d) {
    if (n == null || isNaN(n)) return '--';
    return Number(n).toFixed(d === undefined ? 1 : d) + '%';
}

async function fetchJSON(url) {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return resp.json();
}

function $(id) { return document.getElementById(id); }

// ── Quality Assessment (mirrors scanner logic) ──
function assessQuality(p) {
    const vol = p.vol_ratio || 0;
    const pct52 = p.pct_from_52wk || 0;
    const mom20 = p.mom_20 || 0;
    const rs = p.rs_rank || 0;
    const atr = p.atr || 0;
    const close = p.close || 1;
    const atr_pct = (atr / close) * 100;

    let score = 0;
    const signals = [];
    const red_flags = [];

    // 1. Volume Ratio (20pts)
    if (vol >= 1.7 && vol < 2.0) {
        score += 20; signals.push(['量比', fmt(vol,1)+'x', 20, 20, '1.7-2.0 最佳區間 (勝率83%)']);
    } else if (vol >= 1.5 && vol < 1.7) {
        score += 12; signals.push(['量比', fmt(vol,1)+'x', 12, 20, '溫和放量']);
    } else if (vol >= 2.0 && vol < 2.5) {
        score += 8; signals.push(['量比', fmt(vol,1)+'x', 8, 20, '偏高']);
    } else if (vol >= 2.5 && vol < 3.0) {
        score += 0; signals.push(['量比', fmt(vol,1)+'x', 0, 20, '危險: 2.5-3.0x 勝率僅36%']);
        red_flags.push('量比 2.5-3.0x (勝率36%)');
    } else if (vol >= 3.0 && vol < 5.0) {
        score += 5; signals.push(['量比', fmt(vol,1)+'x', 5, 20, '偏高但不確定']);
    } else {
        score += 10; signals.push(['量比', fmt(vol,1)+'x', 10, 20, '極端放量']);
    }

    // 2. 52-week proximity (20pts)
    if (pct52 >= 95 && pct52 < 100) {
        score += 20; signals.push(['52周接近度', fmt(pct52,0)+'%', 20, 20, '95-100% 最佳 (勝率84.6%)']);
    } else if (pct52 >= 100) {
        score += 10; signals.push(['52周接近度', fmt(pct52,0)+'%', 10, 20, '已在52周高點 (勝率65%)']);
    } else if (pct52 >= 85 && pct52 < 95) {
        score += 5; signals.push(['52周接近度', fmt(pct52,0)+'%', 5, 20, '85-95% 勝率約52%']);
    } else if (pct52 >= 80 && pct52 < 85) {
        score += 2; signals.push(['52周接近度', fmt(pct52,0)+'%', 2, 20, '危險: 80-85% 勝率僅47%']);
        red_flags.push('52周 ' + fmt(pct52,0) + '% (勝率47%)');
    } else {
        score += 8; signals.push(['52周接近度', fmt(pct52,0)+'%', 8, 20, '70-80% 區間']);
    }

    // 3. 20-day momentum (15pts)
    if (mom20 >= 10 && mom20 < 20) {
        score += 15; signals.push(['20日動能', (mom20>=0?'+':'')+fmt(mom20,1)+'%', 15, 15, '10-20% 最佳 (勝率78.6%)']);
    } else if (mom20 >= 5 && mom20 < 10) {
        score += 10; signals.push(['20日動能', (mom20>=0?'+':'')+fmt(mom20,1)+'%', 10, 15, '溫和動能']);
    } else if (mom20 >= 20 && mom20 < 30) {
        score += 8; signals.push(['20日動能', '+'+fmt(mom20,1)+'%', 8, 15, '偏強']);
    } else if (mom20 >= 30 && mom20 < 50) {
        score += 5; signals.push(['20日動能', '+'+fmt(mom20,1)+'%', 5, 15, '過熱中']);
    } else if (mom20 >= 50) {
        score += 2; signals.push(['20日動能', '+'+fmt(mom20,1)+'%', 2, 15, '嚴重過熱 >50%']);
        red_flags.push('20日動能 ' + fmt(mom20,0) + '% 嚴重過熱');
    } else {
        score += 6; signals.push(['20日動能', (mom20>=0?'+':'')+fmt(mom20,1)+'%', 6, 15, '0-5% 區間']);
    }

    // 4. RS Rank (15pts)
    if (rs >= 25 && rs <= 50) {
        score += 15; signals.push(['RS排名', '#'+rs, 15, 15, '25-50 最佳區間 (勝率80.3%)']);
    } else if (rs >= 11 && rs < 25) {
        score += 10; signals.push(['RS排名', '#'+rs, 10, 15, '強勢']);
    } else if (rs > 50 && rs <= 100) {
        score += 7; signals.push(['RS排名', '#'+rs, 7, 15, '中等']);
    } else if (rs >= 1 && rs < 11) {
        score += 5; signals.push(['RS排名', '#'+rs, 5, 15, '前10名 勝率59%']);
    } else {
        score += 3; signals.push(['RS排名', '#'+rs, 3, 15, 'RS偏弱']);
    }

    // 5. Volatility ATR/Price (10pts)
    if (atr_pct < 5) {
        score += 10; signals.push(['波動率', fmt(atr_pct,1)+'%', 10, 10, '<5% 低波動 (勝率72%)']);
    } else if (atr_pct < 7) {
        score += 6; signals.push(['波動率', fmt(atr_pct,1)+'%', 6, 10, '中等波動']);
    } else {
        score += 3; signals.push(['波動率', fmt(atr_pct,1)+'%', 3, 10, '高波動']);
    }

    // Extra red flag
    if (rs < 11 && pct52 < 95) {
        red_flags.push('RS ' + rs + ' 過熱但未接近高點');
    }

    return { score, signals, red_flags };
}

// ── Advanced Indicator Analysis ─────────────────
function rsiAnalysis(rsi) {
    if (rsi >= 55 && rsi <= 80) return { color: 'var(--green)', note: '最佳區間 (55-80)' };
    if (rsi > 80) return { color: 'var(--red)', note: '過熱風險' };
    if (rsi < 50) return { color: 'var(--red)', note: '動能不足' };
    return { color: 'var(--yellow)', note: '可接受' };
}

function cpAnalysis(cp) {
    if (cp > 70) return { color: 'var(--green)', note: '收在高點區 (強勢)' };
    if (cp > 50) return { color: 'var(--yellow)', note: '收在中間區' };
    return { color: 'var(--red)', note: '收在低點區 (弱勢)' };
}

function vzAnalysis(vz) {
    if (vz >= 3) return { color: 'var(--green)', note: '機構級量能 (Z>=3)' };
    if (vz >= 2) return { color: 'var(--green)', note: '強量能信號 (Z>=2)' };
    if (vz >= 1.5) return { color: 'var(--yellow)', note: '溫和放量' };
    return { color: 'var(--text)', note: '一般' };
}

// ── Freshness Check ──────────────────────────────
function getETDate() {
    const now = new Date();
    const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
    return et;
}
function isUSHoliday(d) {
    const holidays = [
        '2025-01-01','2025-01-20','2025-02-17','2025-04-18','2025-05-26',
        '2025-06-19','2025-07-04','2025-09-01','2025-11-27','2025-12-25',
        '2026-01-01','2026-01-19','2026-02-16','2026-04-03','2026-05-25',
        '2026-06-19','2026-07-03','2026-09-07','2026-11-26','2026-12-25',
    ];
    const s = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    return holidays.includes(s);
}
function isTradingDay(d) {
    return d.getDay() >= 1 && d.getDay() <= 5 && !isUSHoliday(d);
}
function lastTradingDay() {
    const et = getETDate();
    // If before 16:30 ET, the latest expected picks are from the previous trading day
    const h = et.getHours(), m = et.getMinutes();
    let d = new Date(et);
    if (h < 16 || (h === 16 && m < 30)) {
        d.setDate(d.getDate() - 1);
    }
    while (!isTradingDay(d)) d.setDate(d.getDate() - 1);
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function checkFreshness(latestDate) {
    const expected = lastTradingDay();
    if (latestDate >= expected) return;
    const banner = $('stale-banner');
    const msg = $('stale-msg');
    msg.textContent = `資料尚未更新至最新交易日（最新: ${latestDate}，應為: ${expected}）`;
    banner.style.display = 'block';
}

// ── Init ─────────────────────────────────────────
async function init() {
    try {
        dateIndex = await fetchJSON('data/index.json');
    } catch (e) {
        showState('data/index.json 不存在', '請先執行 push_picks.py 生成資料');
        return;
    }
    if (!dateIndex || dateIndex.length === 0) {
        showState('尚無選股資料', '請先執行 push_picks.py 生成資料');
        return;
    }
    checkFreshness(dateIndex[0]);
    const hash = window.location.hash.slice(1);
    currentIdx = hash ? Math.max(dateIndex.indexOf(hash), 0) : 0;
    await loadDate();
}

async function loadDate() {
    const date = dateIndex[currentIdx];
    $('current-date').textContent = date;
    window.location.hash = date;
    $('btn-prev').disabled = currentIdx <= 0;
    $('btn-next').disabled = currentIdx >= dateIndex.length - 1;

    try {
        const data = await fetchJSON(`data/${date}.json`);
        renderAll(data);
    } catch (e) {
        showState('資料載入失敗', `無法讀取 data/${date}.json`);
    }
}

function navigate(dir) {
    const newIdx = currentIdx + dir;
    if (newIdx < 0 || newIdx >= dateIndex.length) return;
    currentIdx = newIdx;
    loadDate();
}

// ── Render All ───────────────────────────────────
function renderAll(data) {
    renderDashboard(data);
    renderExits(data.recent_exits || []);
    renderOpenTrades(data.open_trades || []);
    const picks = data.picks || [];
    const vMode = data.v22 || data.v20;
    if (picks.length === 0 || data.no_picks) {
        renderNoPicks(data.date);
    } else {
        renderSignal(picks[0], vMode);
        renderPicksDetail(picks, vMode);
        renderPicks(picks);
    }
    renderQuickRef();
}

// ── Dashboard ────────────────────────────────────
function renderDashboard(data) {
    const v = data.v22 || data.v20 || {};
    const p = data.performance || {};

    const modeEl = $('s-mode');
    modeEl.textContent = v.label || '--';
    modeEl.style.color = v.mode === 'TP' ? 'var(--green)' : 'var(--orange)';

    $('s-rwr').textContent = v.rolling_wr != null ? pct(v.rolling_wr) : '--';
    $('s-rwr').style.color = v.rolling_wr != null ? (v.rolling_wr >= 55 ? 'var(--green)' : 'var(--orange)') : '';



    const picks = data.picks || [];
    const gradeEl = $('s-grade');
    if (picks.length > 0 && picks[0].quality_grade) {
        gradeEl.textContent = picks[0].quality_grade;
        gradeEl.style.color = picks[0].quality_grade === 'A' ? 'var(--green)' :
                              picks[0].quality_grade === 'B' ? 'var(--yellow)' : 'var(--orange)';
    }

    $('s-count').textContent = picks.length > 0 ? picks.length : '--';
    $('s-count').style.color = 'var(--accent)';

    $('s-open').textContent = `${(data.open_trades || []).length}`;
    $('s-open').style.color = 'var(--accent2)';
}

// ── Recent Exits ─────────────────────────────────
function renderExits(exits) {
    const section = $('exits-section');
    if (!exits || exits.length === 0) {
        section.style.display = 'none';
        return;
    }
    section.style.display = 'block';
    $('exit-count').textContent = `(${exits.length} 筆)`;

    $('exits').innerHTML = exits.map(e => {
        const isWin = e.return_pct > 0;
        const isBE = e.return_pct === 0;
        const color = isWin ? 'var(--green)' : isBE ? 'var(--text-dim)' : 'var(--red)';
        const reasonHex = { TP:'#4ecb71', TRAIL:'#4ecdc4', SL:'#ff6b6b', TIME:'#ffd93d', STALE:'#ff9f43' };
        const rc = reasonHex[e.exit_reason] || '#8b90a5';
        return `<div class="exit-card">
            <span class="exit-symbol">${escHtml(e.symbol)}</span>
            <span class="exit-reason" style="background:${rc}22;color:${rc}">${escHtml(e.exit_reason)}</span>
            <span class="exit-return" style="color:${color}">${isWin ? '+' : ''}${fmt(e.return_pct)}%</span>
            <span style="color:var(--text-dim);font-size:0.85em">$${fmt(e.entry_price)} &rarr; $${fmt(e.exit_price)}</span>
        </div>`;
    }).join('');
}

// ── Open Trades ──────────────────────────────────
function computeTierInfo(t) {
    const entry = t.entry_price || 0;
    const highest = t.highest || 0;
    const atr = t.atr || 0;
    if (!entry || entry <= 0) return null;
    const pft = (highest - entry) / entry;
    const tiers = [
        { id: 'T1', label: '0-3%',  min: 0,    max: 0.03, mult: 2.0 },
        { id: 'T2', label: '3-6%',  min: 0.03, max: 0.06, mult: 1.5 },
        { id: 'T3', label: '6-10%', min: 0.06, max: 0.10, mult: 1.2 },
        { id: 'T4', label: '>10%',  min: 0.10, max: 999,  mult: 1.0 },
    ];
    let current = tiers[0];
    for (const tier of tiers) {
        if (pft >= tier.min) current = tier;
    }
    return { pft, current, tiers, atr, entry, highest };
}

function renderNoTPDashboard(t) {
    const info = computeTierInfo(t);
    if (!info) return '';
    const { pft, current, tiers, atr, entry, highest } = info;
    const pftPct = (pft * 100).toFixed(2);
    const pftClass = pft > 0 ? 'positive' : pft < 0 ? 'negative' : 'neutral';
    const trailVal = t.trail && t.trail > 0 ? `$${fmt(t.trail)}` : '--';
    const trailLabel = t.trail_on ? `<strong>${trailVal}</strong>` : trailVal;

    // Tier table rows
    const tierRows = tiers.map(tier => {
        const isActive = tier.id === current.id;
        const arrow = isActive ? '<span class="tier-arrow">&#9654;</span>' : '';
        const trailPrice = atr > 0 ? `$${fmt(highest - atr * tier.mult)}` : '--';
        const priceRange = tier.max < 999
            ? `$${fmt(entry * (1 + tier.min))} - $${fmt(entry * (1 + tier.max))}`
            : `> $${fmt(entry * (1 + tier.min))}`;
        return `<tr class="${isActive ? 'tier-active' : ''}">
            <td>${arrow}${tier.id}</td>
            <td>${tier.label}</td>
            <td>${tier.mult}x ATR</td>
            <td>${trailPrice}</td>
        </tr>`;
    }).join('');

    // Progress steps
    const beTriggered = t.be_set;
    const trailTriggered = t.trail_on;
    const steps = [
        { label: '進場', done: true },
        { label: 'BE', done: beTriggered },
        { label: 'Trail', done: trailTriggered },
        { label: current.id, done: trailTriggered },
    ];
    const progressHTML = steps.map((s, i) => {
        const cls = s.done ? 'step done' : (i > 0 && steps[i-1].done && !s.done ? 'step current' : 'step');
        return `<span class="${cls}">${s.label}</span>`;
    }).join('<span class="arrow">&#8594;</span>');

    return `<div class="notp-dashboard">
        <div class="dash-title">NoTP Tiered ATR 追蹤儀表板</div>
        <div class="notp-profit-row">
            <div>
                <span class="notp-profit-pct ${pftClass}">${pft >= 0 ? '+' : ''}${pftPct}%</span>
                <span style="font-size:0.8em;color:var(--text-dim);margin-left:6px">最高浮盈</span>
            </div>
            <div class="notp-trail-val">追蹤停損: ${trailLabel}</div>
        </div>
        <table class="notp-tier-table">
            <thead><tr><th>級距</th><th>漲幅</th><th>距離</th><th>觸發出場價</th></tr></thead>
            <tbody>${tierRows}</tbody>
        </table>
        <div class="notp-progress">${progressHTML}</div>
    </div>`;
}

function renderOpenTrades(trades) {
    $('open-label').textContent = trades.length > 0 ? `(${trades.length} 筆)` : '';

    if (trades.length === 0) {
        $('open-trades').innerHTML = '<div style="color:var(--text-dim);padding:16px">目前無持倉</div>';
        return;
    }

    $('open-trades').innerHTML = trades.map(t => {
        const modeClass = t.use_tp ? 'mode-tp' : 'mode-notp';
        const modeLabel = t.use_tp ? 'TP' : 'NoTP';
        const pft = t.entry_price > 0 ? ((t.highest - t.entry_price) / t.entry_price * 100) : 0;
        const pftStr = `${pft >= 0 ? '+' : ''}${pft.toFixed(2)}%`;
        const pftClass = pft > 0 ? 'positive' : pft < 0 ? 'negative' : '';

        // TP mode: show TP target price; NoTP mode: no fixed TP
        const tpRow = t.use_tp
            ? `<span class="lbl" style="color:var(--green)">停利</span><span class="val">$${fmt(t.tp)}</span>`
            : `<span class="lbl" style="color:var(--orange)">模式</span><span class="val" style="color:var(--orange)">無上限</span>`;

        const dashboard = !t.use_tp ? renderNoTPDashboard(t) : '';

        const profitRow = t.use_tp
            ? `<div class="tp-profit-row">最高浮盈: <span class="pct ${pftClass}">${pftStr}</span></div>`
            : '';

        return `<div class="trade-card">
            <div class="trade-header">
                <span class="trade-symbol">${escHtml(t.symbol)}</span>
                <span class="trade-mode ${modeClass}">${modeLabel}</span>
            </div>
            <div class="trade-days">Day ${t.days} | 進場 ${t.entry_date}</div>
            <div class="trade-prices">
                <span class="lbl">進場</span><span class="val">$${fmt(t.entry_price)}</span>
                ${tpRow}
                <span class="lbl" style="color:var(--red)">停損</span><span class="val">$${fmt(t.sl)}</span>
                <span class="lbl">最高</span><span class="val">$${fmt(t.highest)}</span>
            </div>
            <div class="trade-status">
                <span>BE: <span class="${t.be_set ? 'on' : 'off'}">${t.be_set ? 'ON' : 'OFF'}</span></span>
                <span>Trail: <span class="${t.trail_on ? 'on' : 'off'}">${t.trail_on ? 'ON' : 'OFF'}</span></span>
            </div>
            ${profitRow}
            ${dashboard}
        </div>`;
    }).join('');
}

// ── Build Operation Plan HTML ────────────────────
function buildPlanHTML(p, v20) {
    const entry = p.entry_price;
    const close = p.close;
    const gap_threshold = close * (1 - PARAMS.gap_reject_pct);
    const be_price = entry * (1 + PARAMS.breakeven_trigger);
    const trail_price = entry * (1 + PARAMS.trail_activation);
    const atr = p.atr || 0;

    // Determine current mode from v20 data
    const isTP = !v20 || v20.mode !== 'NoTP';
    const modeLabel = isTP ? 'TP 模式' : 'NoTP 模式';
    const modeClass = isTP ? 'tp-mode' : 'notp-mode';
    const rollingWR = v20 ? v20.rolling_wr : null;

    // Tiered ATR trail levels (NoTP mode)
    const t1 = entry * 1.03, t2 = entry * 1.06, t3 = entry * 1.10;
    const atr20 = atr * 2.0, atr15 = atr * 1.5, atr12 = atr * 1.2, atr10 = atr * 1.0;

    // TP mode steps
    const tpSteps = `
        <ol class="plan-steps">
            <li><span class="step-num">1</span><span class="step-text">明日開盤檢查: 開盤價 &ge; $${fmt(gap_threshold)} 才進場</span></li>
        </ol>
        <div class="plan-warn">&raquo; 若開盤 &lt; $${fmt(gap_threshold)} (跳空 &gt;3%)，放棄本次訊號</div>
        <ol class="plan-steps" start="2">
            <li><span class="step-num">2</span><span class="step-text">進場買進 @ ~$${fmt(entry)} (ALL-IN)</span></li>
            <li><span class="step-num">3</span><span class="step-text">設定停損 @ <span style="color:var(--red)">$${fmt(p.sl_price)}</span> (ATR &times; ${PARAMS.atr_sl})</span></li>
            <li><span class="step-num">4</span><span class="step-text">漲 +${(PARAMS.breakeven_trigger*100).toFixed(1)}% (<span style="color:var(--accent2)">$${fmt(be_price)}</span>) &rarr; 停損移至成本價 (保本)</span></li>
            <li><span class="step-num">5</span><span class="step-text">漲 +${(PARAMS.trail_activation*100).toFixed(1)}% (<span style="color:var(--accent2)">$${fmt(trail_price)}</span>) &rarr; 啟動 ${(PARAMS.trail_distance*100).toFixed(1)}% 追蹤停損</span></li>
            <li><span class="step-num">6</span><span class="step-text">停利 @ <span style="color:var(--green)">$${fmt(p.tp_price)}</span> (+${(PARAMS.tp_target*100).toFixed(0)}%)</span></li>
            <li><span class="step-num">7</span><span class="step-text">持倉 ${PARAMS.stale_days} 天若仍虧損 &gt;${Math.abs(PARAMS.stale_threshold*100).toFixed(0)}%，收盤出場 (停滯出場)</span></li>
            <li><span class="step-num">8</span><span class="step-text">最長持有 ${PARAMS.time_stop} 個交易日，到期收盤出場</span></li>
        </ol>`;

    // NoTP mode steps (Tiered ATR Trail) — with concrete trigger prices
    const notp_be = entry * 1.008;
    const notp_trail_start = entry * 1.02;
    // Trail stop examples: if price reaches tier boundary, what's the exit trigger?
    const trail_at_t1 = t1 - atr20;  // trail stop if highest = t1
    const trail_at_t2 = t2 - atr15;  // trail stop if highest = t2
    const trail_at_t3 = t3 - atr12;  // trail stop if highest = t3
    const trail_at_t4 = entry * 1.15 - atr10; // example at +15%

    const notpSteps = `
        <ol class="plan-steps">
            <li><span class="step-num">1</span><span class="step-text">明日開盤檢查: 開盤價 &ge; $${fmt(gap_threshold)} 才進場</span></li>
        </ol>
        <div class="plan-warn">&raquo; 若開盤 &lt; $${fmt(gap_threshold)} (跳空 &gt;3%)，放棄本次訊號</div>
        <ol class="plan-steps" start="2">
            <li><span class="step-num">2</span><span class="step-text">進場買進 @ ~$${fmt(entry)} (ALL-IN)</span></li>
            <li><span class="step-num">3</span><span class="step-text">設定停損 @ <span style="color:var(--red)">$${fmt(p.sl_price)}</span> (ATR &times; ${PARAMS.atr_sl})</span></li>
            <li><span class="step-num">4</span><span class="step-text">漲 +0.8% 達 <span style="color:var(--accent2)">$${fmt(notp_be)}</span> &rarr; 停損移至成本價 $${fmt(entry)} (保本)</span></li>
            <li><span class="step-num">5</span><span class="step-text">漲 +2.0% 達 <span style="color:var(--accent2)">$${fmt(notp_trail_start)}</span> &rarr; 啟動 Tiered ATR 追蹤停損</span></li>
        </ol>
        <div style="margin:8px 0 4px;font-size:0.85em;color:var(--orange);font-weight:600">&#9733; Tiered ATR 追蹤停損 — 無固定停利上限，讓贏家持續奔跑</div>
        <table class="tiered-table">
            <thead><tr><th>級距</th><th>漲幅範圍</th><th>追蹤距離</th><th>ATR 停損距</th><th>範例出場價</th></tr></thead>
            <tbody>
                <tr><td>T1</td><td>0-3% (&lt; $${fmt(t1)})</td><td>2.0 &times; ATR</td><td>$${fmt(atr20)}</td><td style="color:var(--red)">$${fmt(trail_at_t1)}</td></tr>
                <tr><td>T2</td><td>3-6% ($${fmt(t1)}-$${fmt(t2)})</td><td>1.5 &times; ATR</td><td>$${fmt(atr15)}</td><td style="color:var(--red)">$${fmt(trail_at_t2)}</td></tr>
                <tr><td>T3</td><td>6-10% ($${fmt(t2)}-$${fmt(t3)})</td><td>1.2 &times; ATR</td><td>$${fmt(atr12)}</td><td style="color:var(--red)">$${fmt(trail_at_t3)}</td></tr>
                <tr><td>T4</td><td>&gt;10% (&gt; $${fmt(t3)})</td><td>1.0 &times; ATR</td><td>$${fmt(atr10)}</td><td style="color:var(--red)">$${fmt(trail_at_t4)}</td></tr>
            </tbody>
        </table>
        <div style="margin:6px 0;padding:8px 12px;background:rgba(255,159,67,0.08);border-radius:6px;font-size:0.82em;color:var(--text-dim)">
            <strong style="color:var(--orange)">操作要點：</strong>
            股價越漲，追蹤停損越緊。例如漲到 T2 ($${fmt(t1)}+) 後，若回調 $${fmt(atr15)} (1.5&times;ATR) 即觸發出場。
            漲超過 10% 進入 T4 後，僅容忍 $${fmt(atr10)} (1.0&times;ATR) 回調。
        </div>
        <ol class="plan-steps" start="6">
            <li><span class="step-num">6</span><span class="step-text">持倉 ${PARAMS.stale_days} 天若仍虧損 &gt;${Math.abs(PARAMS.stale_threshold*100).toFixed(0)}%，收盤出場 (停滯出場)</span></li>
            <li><span class="step-num">7</span><span class="step-text">最長持有 ${PARAMS.time_stop} 個交易日，到期收盤出場</span></li>
        </ol>`;

    // Mode comparison section
    const modeCompare = `
    <div class="mode-compare">
        <div class="plan-title">TP vs NoTP 模式對照</div>
        <div class="mode-indicator ${modeClass}">
            &#x25CF; 目前模式：${modeLabel}${rollingWR != null ? ` (Rolling WR: ${fmt(rollingWR, 1)}%)` : ''}
        </div>
        <div class="mode-compare-grid">
            <div class="mode-box${isTP ? ' active' : ''}">
                <div class="mode-box-title">
                    <span class="mode-dot" style="background:var(--green)"></span>
                    TP 模式 <span style="font-size:0.8em;color:var(--text-dim)">(WR &ge; 55%)</span>
                </div>
                <ul>
                    <li>固定停利 +${(PARAMS.tp_target*100).toFixed(0)}%</li>
                    <li>保本觸發 +0.8%</li>
                    <li>追蹤停損 ${(PARAMS.trail_distance*100).toFixed(1)}%</li>
                    <li>市場強勢時快速兌現</li>
                    <li>資金輪轉更快</li>
                </ul>
            </div>
            <div class="mode-box${!isTP ? ' active' : ''}">
                <div class="mode-box-title">
                    <span class="mode-dot" style="background:var(--orange)"></span>
                    NoTP 模式 <span style="font-size:0.8em;color:var(--text-dim)">(WR &lt; 55%)</span>
                </div>
                <ul>
                    <li>無固定停利上限</li>
                    <li>保本觸發 +0.8%</li>
                    <li>Tiered ATR 追蹤 (2.0x&rarr;1.0x)</li>
                    <li>市場一般時讓贏家跑更遠</li>
                    <li>單筆贏家潛力更大</li>
                </ul>
            </div>
        </div>
    </div>`;

    return `
    <div class="plan-section">
        <div class="plan-title">操作計畫 <span class="mode-indicator ${modeClass}" style="margin:0;vertical-align:middle">&#x25CF; ${modeLabel}</span></div>
        ${isTP ? tpSteps : notpSteps}
        ${modeCompare}
    </div>`;
}

// ── Build Quality Analysis HTML ──────────────────
function buildQualityHTML(p) {
    const qa = assessQuality(p);

    const rows = qa.signals.map(([name, val, pts, max, reason]) => {
        const c = pts >= max * 0.7 ? 'var(--green)' : pts >= max * 0.4 ? 'var(--yellow)' : 'var(--red)';
        return `<tr>
            <td>${name}</td>
            <td class="num">${val}</td>
            <td class="qa-score" style="color:${c}">${pts}/${max}</td>
            <td class="qa-reason">${reason}</td>
        </tr>`;
    }).join('');

    let flagsHTML = '';
    if (qa.red_flags.length > 0) {
        flagsHTML = `<div class="red-flags">
            <div class="red-flags-title">紅旗警告</div>
            <ul>${qa.red_flags.map(f => `<li>${f}</li>`).join('')}</ul>
        </div>`;
    } else if (p.quality_score >= 65) {
        flagsHTML = '<div class="no-flags">無紅旗警告，品質訊號良好。</div>';
    }

    return `
    <div class="qa-section">
        <div class="plan-title">突破品質分析</div>
        <table class="qa-table">
            <thead><tr>
                <th>訊號</th>
                <th class="num">數值</th>
                <th class="num">得分</th>
                <th>分析</th>
            </tr></thead>
            <tbody>${rows}</tbody>
        </table>
        ${flagsHTML}
    </div>`;
}

// ── Build Advanced Indicators HTML ───────────────
function buildAdvancedHTML(p) {
    const rsi = p.rsi_14 || 0;
    const cp = p.close_position || 0;
    const vz = p.vol_zscore || 0;

    const ra = rsiAnalysis(rsi);
    const ca = cpAnalysis(cp);
    const va = vzAnalysis(vz);

    return `
    <div class="adv-section">
        <div class="plan-title">進階指標</div>
        <div class="adv-row">
            <span class="adv-label">RSI(14)</span>
            <span class="adv-value" style="color:${ra.color}">${fmt(rsi, 1)}</span>
            <span class="adv-note">${ra.note}</span>
        </div>
        <div class="adv-row">
            <span class="adv-label">K線品質</span>
            <span class="adv-value" style="color:${ca.color}">${fmt(cp, 0)}%</span>
            <span class="adv-note">${ca.note}</span>
        </div>
        <div class="adv-row">
            <span class="adv-label">量能Z分</span>
            <span class="adv-value" style="color:${va.color}">${fmt(vz, 1)}\u03c3</span>
            <span class="adv-note">${va.note}</span>
        </div>
    </div>`;
}

// ── No Picks Message ─────────────────────────────
function renderNoPicks(date) {
    const html = `<div class="card" style="text-align:center;padding:32px">
        <h3 style="color:var(--yellow);margin-bottom:12px">今日無符合條件的標的</h3>
        <p style="color:var(--text-dim)">這是正常的 — V22 平均每年約 75 個訊號（約每 3-4 天一個）</p>
        <p style="color:var(--text-dim);font-size:0.85em;margin-top:12px">
            策略等待以下條件同時滿足：量能突增 >= 1.5x ・ 量能Z分 >= 1.0σ ・ 接近52週高點 >= 80% ・ SMA20 上升 ・ 盤整收斂
        </p>
    </div>`;
    $('signal').innerHTML = html;
    $('picks-detail').innerHTML = '';
    $('picks-table').innerHTML = '';
}

// ── Signal Card (#1 Pick - Full Report) ──────────
function renderSignal(pick, v20) {
    if (!pick) {
        $('signal').innerHTML = '<div style="color:var(--text-dim);padding:16px">今日無候選股</div>';
        return;
    }
    const gc = gradeColor(pick.quality_grade);
    const rr = pick.risk_pct > 0 ? (pick.reward_pct / pick.risk_pct).toFixed(2) : '--';
    const position_val = (pick.shares && pick.entry_price) ? (pick.shares * pick.entry_price).toFixed(0) : '0';
    const sectorHTML = pick.sector
        ? `${escHtml(pick.sector)} &mdash; 板塊排名 #${pick.sector_rank}`
        : '<span style="color:var(--text-dim)">板塊資訊不可用</span>';

    $('signal').innerHTML = `
    <div class="signal-card">
        <div class="signal-top">
            <span class="signal-symbol">${escHtml(pick.symbol)}</span>
            <span class="signal-grade" style="background:${gc}22;color:${gc}">
                ${escHtml(pick.quality_grade)} ${fmt(pick.quality_score, 0)}分
            </span>
            <span class="signal-desc">${gradeDesc(pick.quality_grade)}</span>
        </div>
        <div class="signal-sector">${sectorHTML}</div>

        <div class="signal-prices">
            <div class="price-box">
                <div class="p-label">收盤</div>
                <div class="p-value">$${fmt(pick.close)}</div>
            </div>
            <div class="price-box">
                <div class="p-label">進場</div>
                <div class="p-value">$${fmt(pick.entry_price)}</div>
            </div>
            <div class="price-box" style="border:1px solid var(--green)">
                <div class="p-label" style="color:var(--green)">停利</div>
                <div class="p-value" style="color:var(--green)">$${fmt(pick.tp_price)}</div>
            </div>
            <div class="price-box" style="border:1px solid var(--red)">
                <div class="p-label" style="color:var(--red)">停損</div>
                <div class="p-value" style="color:var(--red)">$${fmt(pick.sl_price)}</div>
            </div>
        </div>

        <div class="signal-risk">
            風險 <span style="color:var(--red)">${fmt(pick.risk_pct)}%</span>
            &nbsp;|&nbsp;
            報酬 <span style="color:var(--green)">${fmt(pick.reward_pct)}%</span>
            &nbsp;|&nbsp;
            盈虧比 <span style="color:var(--accent)">${rr}</span>
            &nbsp;|&nbsp;
            股數 <span style="color:var(--accent)">${pick.shares}</span>
            &nbsp;|&nbsp;
            部位 <span style="color:var(--accent)">$${Number(position_val).toLocaleString()}</span>
        </div>

        <div class="metrics-grid">
            ${mk('RS 排名', '#' + pick.rs_rank)}
            ${mk('量比', fmt(pick.vol_ratio) + 'x')}
            ${mk('盤整度', fmt(pick.tightness))}
            ${mk('RSI', fmt(pick.rsi_14, 1))}
            ${mk('20日動能', pct(pick.mom_20, 1))}
            ${mk('均線斜率', fmt(pick.sma20_slope, 4))}
            ${mk('52W接近度', pct(pick.pct_from_52wk, 1))}
            ${mk('量能Z', fmt(pick.vol_zscore))}
            ${mk('K線品質', pct(pick.close_position, 1))}
            ${mk('ATR', '$' + fmt(pick.atr))}
        </div>

        ${buildPlanHTML(pick, v20)}
        ${buildQualityHTML(pick)}
        ${buildAdvancedHTML(pick)}
    </div>`;
}

function mk(label, value) {
    return `<div class="metric"><div class="m-label">${label}</div><div class="m-value">${value}</div></div>`;
}

// ── All Picks Detail Cards ──────────────────────
function renderPicksDetail(picks, v20) {
    $('pick-count').textContent = `(${picks.length} 檔)`;

    if (!picks || picks.length === 0) {
        $('picks-detail').innerHTML = '<div style="color:var(--text-dim);padding:16px">今日無候選股</div>';
        return;
    }

    // Skip #1 (already shown in signal card) - show #2 onwards
    const rest = picks.slice(1);
    if (rest.length === 0) {
        $('picks-detail').innerHTML = '<div style="color:var(--text-dim);padding:16px;font-size:0.9em">今日僅一檔候選股 (已顯示於上方)</div>';
        return;
    }

    $('picks-detail').innerHTML = rest.map(p => {
        const gc = gradeColor(p.quality_grade);
        const rr = p.risk_pct > 0 ? (p.reward_pct / p.risk_pct).toFixed(2) : '--';
        const gap_threshold = p.close * (1 - PARAMS.gap_reject_pct);
        const be_price = p.entry_price * (1 + PARAMS.breakeven_trigger);
        const trail_price = p.entry_price * (1 + PARAMS.trail_activation);
        const position_val = (p.shares && p.entry_price) ? (p.shares * p.entry_price).toFixed(0) : '0';
        const secStr = p.sector ? `${escHtml(p.sector)} #${p.sector_rank}` : '';

        return `<div class="pick-detail-card" onclick="this.classList.toggle('open')">
            <div class="pick-detail-header">
                <span class="pick-detail-rank">${p.rank}</span>
                <span class="pick-detail-sym">${escHtml(p.symbol)}</span>
                <span class="grade-badge" style="background:${gc}22;color:${gc}">${escHtml(p.quality_grade)} ${fmt(p.quality_score, 0)}分</span>
                <span style="color:var(--text-dim);font-size:0.85em">${secStr}</span>
                <span class="pick-detail-toggle">[點擊展開]</span>
                <span class="pick-detail-prices">
                    <span>$${fmt(p.close)}</span>
                    <span style="color:var(--green)">TP $${fmt(p.tp_price)}</span>
                    <span style="color:var(--red)">SL $${fmt(p.sl_price)}</span>
                </span>
            </div>
            <div class="pick-detail-body">
                <div class="detail-2col">
                    <span class="d-lbl">股價</span><span class="d-val">$${fmt(p.close)}</span>
                    <span class="d-lbl">進場價</span><span class="d-val">$${fmt(p.entry_price)}</span>
                    <span class="d-lbl">RS排名</span><span class="d-val">${p.rs_rank}</span>
                    <span class="d-lbl" style="color:var(--green)">停利</span><span class="d-val" style="color:var(--green)">$${fmt(p.tp_price)} (+${fmt(p.reward_pct)}%)</span>
                    <span class="d-lbl">量比</span><span class="d-val">${fmt(p.vol_ratio)}x</span>
                    <span class="d-lbl" style="color:var(--red)">停損</span><span class="d-val" style="color:var(--red)">$${fmt(p.sl_price)} (-${fmt(p.risk_pct)}%)</span>
                    <span class="d-lbl">52周</span><span class="d-val">${pct(p.pct_from_52wk, 1)}</span>
                    <span class="d-lbl">盈虧比</span><span class="d-val">${rr}</span>
                    <span class="d-lbl">20日動能</span><span class="d-val">${pct(p.mom_20, 1)}</span>
                    <span class="d-lbl">股數</span><span class="d-val">${p.shares}</span>
                    <span class="d-lbl">盤整度</span><span class="d-val">${fmt(p.tightness)}</span>
                    <span class="d-lbl">部位</span><span class="d-val">$${Number(position_val).toLocaleString()}</span>
                    <span class="d-lbl">SMA20斜率</span><span class="d-val">${fmt(p.sma20_slope, 4)}</span>
                    <span class="d-lbl">ATR</span><span class="d-val">$${fmt(p.atr)}</span>
                </div>
                ${buildPlanHTML(p, v20)}
                ${buildQualityHTML(p)}
                ${buildAdvancedHTML(p)}
            </div>
        </div>`;
    }).join('');
}

// ── Quick Reference ─────────────────────────────
function renderQuickRef() {
    $('quick-ref').innerHTML = `
    <div class="quick-ref">
        <div class="quick-ref-title">快速參考</div>
        <div class="quick-ref-row">
            <span class="qr-label" style="color:var(--green)">最佳訊號:</span>
            <span class="qr-items">量比 1.7-2.0x (83%) | 52周 95-100% (85%) | 20日動能 10-20% (79%) | RS 25-50名 (80%)</span>
        </div>
        <div class="quick-ref-row">
            <span class="qr-label" style="color:var(--red)">紅旗警告:</span>
            <span class="qr-items">量比 2.5-3.0x (36%) | 5日動能 &lt;-5% (40%) | 52周 80-85% (47%) | 跳空 &gt;10% (33%)</span>
        </div>
        <div class="quick-ref-row">
            <span class="qr-label" style="color:var(--accent)">TP 模式:</span>
            <span class="qr-items">SL=ATR&times;1.3 | 保本 +0.8% | 追蹤 +1.8% (3.1%) | 停利 +15% | 停滯 9天&gt;5% | 時間停 10天</span>
        </div>
        <div class="quick-ref-row">
            <span class="qr-label" style="color:var(--orange)">NoTP 模式:</span>
            <span class="qr-items">SL=ATR&times;1.3 | 保本 +0.8% | Tiered ATR 追蹤 (2.0x&rarr;1.0x) | 無停利上限 | 停滯 9天&gt;5% | 時間停 10天</span>
        </div>
        <div class="quick-ref-row">
            <span class="qr-label" style="color:var(--text-dim)">模式切換:</span>
            <span class="qr-items">Rolling 20-trade WR &ge; 55% &rarr; TP 模式 | WR &lt; 55% &rarr; NoTP 模式 | 前 20 筆 = TP 模式 (暖機)</span>
        </div>
    </div>`;
}

// ── Picks Table (Quick Overview) ─────────────────
function renderPicks(picks) {
    if (!picks || picks.length === 0) {
        $('picks-table').innerHTML = '<div style="color:var(--text-dim);padding:16px">今日無候選股</div>';
        return;
    }

    const rows = picks.map(p => {
        const gc = gradeColor(p.quality_grade);
        const rr = p.risk_pct > 0 ? (p.reward_pct / p.risk_pct).toFixed(1) : '--';
        return `<tr>
            <td class="num">${p.rank}</td>
            <td><strong>${escHtml(p.symbol)}</strong></td>
            <td><span class="grade-badge" style="background:${gc}22;color:${gc}">${escHtml(p.quality_grade)}</span></td>
            <td class="num">${fmt(p.quality_score, 0)}</td>
            <td>${escHtml(p.sector || '')}</td>
            <td class="num">$${fmt(p.close)}</td>
            <td class="num">$${fmt(p.entry_price)}</td>
            <td class="num" style="color:var(--green)">$${fmt(p.tp_price)}</td>
            <td class="num" style="color:var(--red)">$${fmt(p.sl_price)}</td>
            <td class="num">${fmt(p.risk_pct)}%</td>
            <td class="num">${rr}</td>
            <td class="num">${p.rs_rank}</td>
            <td class="num">${fmt(p.vol_ratio)}</td>
            <td class="num">${fmt(p.rsi_14, 1)}</td>
            <td class="num">${pct(p.mom_20, 1)}</td>
            <td class="num">${pct(p.pct_from_52wk, 1)}</td>
        </tr>`;
    }).join('');

    $('picks-table').innerHTML = `<table>
        <thead><tr>
            <th class="num">#</th>
            <th>代碼</th>
            <th>評級</th>
            <th class="num">分數</th>
            <th>板塊</th>
            <th class="num">收盤</th>
            <th class="num">進場</th>
            <th class="num">停利</th>
            <th class="num">停損</th>
            <th class="num">風險%</th>
            <th class="num">R:R</th>
            <th class="num">RS</th>
            <th class="num">量比</th>
            <th class="num">RSI</th>
            <th class="num">動能</th>
            <th class="num">52W%</th>
        </tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
}

// ── State Messages ───────────────────────────────
function showState(title, desc) {
    $('exits-section').style.display = 'none';
    $('open-trades').innerHTML = '';
    $('open-label').textContent = '';
    $('picks-table').innerHTML = '';
    $('picks-detail').innerHTML = '';
    $('pick-count').textContent = '';
    $('quick-ref').innerHTML = '';
    ['s-mode','s-rwr','s-grade','s-count','s-open'].forEach(id => { $(id).textContent = '--'; $(id).style.color = ''; });
    $('signal').innerHTML = `<div class="state-msg">
        <div class="icon">&#x1F4CA;</div>
        <p><strong>${title}</strong></p>
        <p style="margin-top:8px;font-size:0.9em">${desc}</p>
    </div>`;
}

// ── Bootstrap ────────────────────────────────────
init();
window.addEventListener('hashchange', () => {
    const hash = window.location.hash.slice(1);
    const idx = dateIndex.indexOf(hash);
    if (idx >= 0 && idx !== currentIdx) {
        currentIdx = idx;
        loadDate();
    }
});
</script>

</body>
</html>
